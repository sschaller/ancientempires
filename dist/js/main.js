window.AE=function(){var t;!function(t){t[t.Bold=0]="Bold",t[t.Large=1]="Large"}(t||(t={}));var e,i=function(){function e(t,e,i,s,n){this.x=t,this.y=e,this.style=s,this.text=n||"",this.group=i,this.letters=[],this.draw()}return e.getWidth=function(e,i){return e==t.Bold?7*i:10*i},e.getFontIndex=function(e,i){return e==t.Large?i>=48&&57>=i?i-48:(console.log("Don't recognize char code "+i+" for font large"),0):i>=65&&90>i?i-65:i>=49&&57>=i?i-49+27:48==i?14:45==i?25:43==i?26:(console.log("Don't recognize char code "+i+" for font bold"),0)},e.prototype.setText=function(t){this.text=t,this.draw()},e.prototype.updatePosition=function(t,e){this.x=t,this.y=e;for(var i=0,s=this.letters;i<s.length;i++){var n=s[i];n.x=t,n.y=e,t+=n.width}},e.prototype.setVisibility=function(t){for(var e=0,i=this.letters;e<i.length;e++){var s=i[e];s.visible=t}},e.prototype.draw=function(){for(var i=[],s=this.x,n=0;n<this.text.length;n++){var o=this.text.charCodeAt(n),a=e.getFontIndex(this.style,o);if(0>a)s+=e.getWidth(this.style,1);else{var r=void 0;this.style==t.Bold?r="chars":this.style==t.Large&&(r="lchars");var h=void 0;h=this.letters.length>0?this.letters.shift():q.game.add.image(s,this.y,r,null,this.group),h.frame=a,i.push(h),s+=h.width}}for(;this.letters.length>0;){var p=this.letters.shift();p.destroy()}this.letters=i},e}(),s=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},n=function(){function t(t,e,i){this.alliance=t,this.map=e,this.delegate=i}return t.prototype.isPlayer=function(){return!1},t.prototype.isActive=function(){return!!this.getCursorPosition()},t.prototype.setCursorPosition=function(t){this.cursor_position=t.copy()},t.prototype.getCursorPosition=function(){if(this.cursor_position)return this.cursor_position.copy();var t=this.map.getKingPosition(this.alliance);if(t)return t.copy();var e=this.map.getEntitiesWith(this.alliance);return e.length>0?e[0].position:null},t.prototype.start=function(){},t.prototype.run=function(){},t.prototype.entityDidMove=function(t){},t.prototype.entityDidAnimation=function(t){},t.prototype.openMenu=function(t){},t.prototype.closeMenu=function(t){},t}(),s=(function(t){function e(){t.apply(this,arguments)}return s(e,t),e.prototype.run=function(){this.delegate.nextTurn()},e}(n),this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});!function(t){t[t.None=0]="None",t[t.Select=1]="Select",t[t.Moving=2]="Moving",t[t.Action=3]="Action",t[t.Attack=4]="Attack",t[t.Raise=5]="Raise",t[t.Deselect=6]="Deselect"}(e||(e={}));var o,a=function(t){function i(i,s,n){t.call(this,i,s,n),this.state=e.None,this.pause=!1,this.test=[k.Wizard,k.Lizard]}return s(i,t),i.getTileScore=function(t){switch(t){case M.Forest:case M.Hill:return 2;case M.Mountain:case M.Water:return 3}return 1},i.prototype.openMenu=function(t){t==B.Wait&&(this.pause=!0)},i.prototype.closeMenu=function(t){t==B.Wait&&(this.pause=!1)},i.prototype.entityDidMove=function(t){this.state=e.Action},i.prototype.entityDidAnimation=function(t){this.delegate.cursor.show(),this.state=e.Deselect},i.prototype.run=function(){if(this.delegate.camera_still&&this.delegate.cursor_still&&!this.pause)if(this.state==e.None){for(var t=0,i=this.map.entities;t<i.length;t++){var s=i[t];if(s.alliance==this.alliance&&s.state==I.Ready){if(9==s.type){if(1!=this.map.countEntitiesWith(this.alliance,I.Ready))continue;if(this.map.getTileAt(s.position)==M.Castle&&this.map.getAllianceAt(s.position)==s.alliance)if(this.map.countEntitiesWith(this.alliance,void 0,k.Soldier)<2&&this.checkCostAndSpace(s.position,k.Soldier))s=this.delegate.buyEntity(s,k.Soldier);else if(this.test.length>0)this.delegate.getGoldForAlliance(this.alliance)>=q.ENTITIES[this.test[0]].cost&&(s=this.delegate.buyEntity(s,this.test[0]),this.test.shift());else{for(var n=[],o=1;o<q.ENTITIES.length;o++)this.map.countEntitiesWith(this.alliance,void 0,o)>=1&&q.ENTITIES[o].cost<600||this.checkCostAndSpace(s.position,o)&&n.push(o);if(n.length>0){var a=n[Math.floor(Math.random()*n.length)];s=this.delegate.buyEntity(s,a)}}}this.delegate.cursor_target=s.position.copy(),this.state=e.Select,this.entity_selected=s,this.selectEntity(s);var r=this.delegate.showRange(A.Move,s);r.sort(),this.soldiers=this.map.getEntitiesWith(this.alliance,void 0,k.Soldier),this.nearest_house=this.map.getNearestHouseForEntity(s);for(var h=0,p=0,c=r.waypoints;p<c.length;p++){var l=c[p],u=this.map.getEntityAt(l.position);if(!u||u==s){if(!s.hasFlag(v.CantAttackAfterMoving)||u==s)for(var g=this.map.getAttackTargets(s,l.position),d=0,y=g;d<y.length;d++){var f=y[d],_=this.getScore(s,l.position,f,null);h>=_||(h=_,this.entity_raise=null,this.entity_attack=f,this.entity_target=l.position.copy())}if(s.hasFlag(v.CanRaise))for(var g=this.map.getRaiseTargets(s,l.position),m=0,w=g;m<w.length;m++){var f=w[m],E=this.getScore(s,l.position,null,f);h>=E||(h=E,this.entity_attack=null,this.entity_raise=f,this.entity_target=l.position.copy())}var S=this.getScore(s,l.position,null,null);h>=S||(h=S,this.entity_attack=null,this.entity_raise=null,this.entity_target=l.position.copy())}}return}}this.soldiers=null,this.delegate.nextTurn()}else switch(this.state){case e.Select:this.delegate.cursor_target.match(this.entity_target)?(this.delegate.moveEntity(this.selected_entity,this.entity_target,!0),this.state=e.Moving):this.delegate.cursor_target=this.entity_target.copy();break;case e.Action:if(this.entity_attack)return void(this.delegate.cursor_target.match(this.entity_attack.position)?(this.delegate.attackEntity(this.selected_entity,this.entity_attack),this.state=e.Attack):(this.delegate.cursor_target=this.entity_attack.position.copy(),this.delegate.cursor.hide(),this.delegate.showRange(A.Attack,this.selected_entity),this.map.selectTargetInRange(this.entity_attack)));if(this.entity_raise)return void(this.delegate.cursor_target.match(this.entity_raise.position)?(this.delegate.raiseEntity(this.selected_entity,this.entity_raise),this.state=e.Raise):(this.delegate.showRange(A.Raise,this.selected_entity),this.delegate.cursor_target=this.entity_raise.position.copy()));this.selected_entity.hasFlag(v.CanOccupyHouse)&&this.map.getTileAt(this.entity_target)==M.House&&this.map.getAllianceAt(this.entity_target)!=this.alliance&&this.delegate.occupy(this.entity_target,this.alliance),this.state=e.Deselect;break;case e.Deselect:this.selected_entity.updateState(I.Moved,!0),this.delegate.deselectEntity(!0),this.state=e.None}},i.prototype.selectEntity=function(t){this.selected_entity=t,this.delegate.selectEntity(t)},i.prototype.checkCostAndSpace=function(t,e){if(this.delegate.getGoldForAlliance(this.alliance)<q.ENTITIES[e].cost)return!1;var i=this.map.entity_range.calculateWaypoints(t,this.alliance,e,q.ENTITIES[e].mov,!0);return!(i.length<2)},i.prototype.getScore=function(t,e,s,n){var o=0;switch(t.type){case k.Soldier:if(this.map.getKingPosition(this.alliance)&&this.nearest_house){var a=this.map.width+this.map.height-e.distanceTo(this.nearest_house.position);o+=a*a}i.getTileScore(this.map.getTileAt(e))<=1&&(o+=5);for(var r=0,h=this.soldiers;r<h.length;r++){var p=h[r];if(p!=t){var c=t.getDistanceToEntity(p);o+=c*c}}this.map.getTileAt(e)!=M.House||this.map.getAllianceAt(e)==t.alliance||s||(o+=200);break;case k.Wizard:n&&(o+=100);break;case k.King:e.match(t.position)&&(o+=200)}s&&(o+=s.shouldCounter(e)?t.getPowerEstimate(e,this.map)-s.getPowerEstimate(e,this.map)+10-s.health:2*t.getPowerEstimate(e,this.map),s.type==k.King&&(o+=10)),o+=2*this.map.getDefAt(e,t.type);var l=this.map.getKingPosition(this.alliance==N.Red?N.Blue:N.Red);if(l&&(o+=2*(this.map.width+this.map.height-e.distanceTo(l))),this.map.getTileAt(e)==M.House&&this.map.getAllianceAt(e)==t.alliance&&(o+=2*(10-t.health)),t.health<5&&t.type!=k.Soldier&&this.nearest_house){var u=this.map.width+this.map.height-e.distanceTo(this.nearest_house.position);o+=u*u}if(2==this.map.getMap()&&this.nearest_house){var g=Math.abs(this.nearest_house.position.x-e.x)-1,d=Math.abs(this.nearest_house.position.y-e.y)-3;0>g&&(g=0),0>d&&(d=0);var y=this.map.width+this.map.height-2*(g+d);o+=y*y}return o+=10*t.position.distanceTo(e)/(t.data.mov-1),Math.floor(o)},i}(n),r=function(){function t(t,e){this.x=t,this.y=e}return t.prototype.match=function(t){return!!t&&this.x==t.x&&this.y==t.y},t.prototype.copy=function(e){switch(void 0===e&&(e=o.None),e){case o.Up:return new t(this.x,this.y-1);case o.Right:return new t(this.x+1,this.y);case o.Down:return new t(this.x,this.y+1);case o.Left:return new t(this.x-1,this.y)}return new t(this.x,this.y)},t.prototype.move=function(t){switch(t){case o.Up:this.y--;break;case o.Right:this.x++;break;case o.Down:this.y++;break;case o.Left:this.x--}return this},t.prototype.distanceTo=function(t){return Math.abs(t.x-this.x)+Math.abs(t.y-this.y)},t.prototype.getDirectionTo=function(t){return t.x>this.x?o.Right:t.x<this.x?o.Left:t.y>this.y?o.Down:t.y<this.y?o.Up:o.None},t.prototype.getWorldPosition=function(){return new t(this.x*q.TILE_SIZE,this.y*q.TILE_SIZE)},t.prototype.getI=function(){return{x:this.x,y:this.y}},t}();!function(t){t[t.None=0]="None",t[t.Up=1]="Up",t[t.Right=2]="Right",t[t.Down=4]="Down",t[t.Left=8]="Left",t[t.All=15]="All"}(o||(o={}));var h,p=function(){function t(){}return t.prototype.init=function(t,e,i,s){void 0===s&&(s=[]),this.world_position=t,this.offset_x=0,this.offset_y=0,this.name=i,this.frames=s,this.sprite=e.game.add.sprite(this.world_position.x,this.world_position.y,this.name),this.sprite.frame=this.frames[0],e.add(this.sprite)},t.prototype.setFrames=function(t,e){void 0===e&&(e=0),this.frames=t,this.frame=e,this.sprite.frame=this.frames[this.frame%this.frames.length]},t.prototype.setOffset=function(t,e){this.offset_x=t,this.offset_y=e,this.update()},t.prototype.setFrame=function(t){t!=this.frame&&(this.frame=t,this.sprite.frame=this.frames[this.frame%this.frames.length])},t.prototype.setWorldPosition=function(t){this.world_position=t,this.update()},t.prototype.update=function(t){void 0===t&&(t=1),this.sprite.x=this.world_position.x+this.offset_x,this.sprite.y=this.world_position.y+this.offset_y},t.prototype.hide=function(){this.sprite.visible=!1},t.prototype.show=function(){this.sprite.visible=!0},t.prototype.destroy=function(){this.sprite.destroy()},t}(),c=function(){function t(t){var e=this;this.ret=function(){e.counter--,e.counter>0||!e.awaiting||e.callback()},this.counter=0,this.awaiting=!1,this.callback=t}return t.prototype.await=function(){this.awaiting=!0,this.counter<=0&&this.callback()},t.prototype.add=function(){this.counter++},t}(),l=function(){function t(){}return t.bufferToBase64=function(t){var e=Array.prototype.map.call(t,function(t){return String.fromCharCode(t)}).join("");return btoa(e)},t.loadSpriteSheet=function(e,i,s,n,o,a){var r=i;if("undefined"==typeof s||"undefined"==typeof n||"undefined"==typeof o){var h=q.game.cache.getBinary(i+".sprite"),p=new DataView(h),l=0;"undefined"==typeof o&&(o=p.getUint8(l++)),"undefined"==typeof s&&(s=p.getUint8(l++)),"undefined"==typeof n&&(n=p.getUint8(l++))}if(q.game.cache.checkBinaryKey(i+".png")){var u=q.game.cache.getBinary(i+".png");"undefined"!=typeof a&&(u=t.createVariation(u,a),r+="_"+a);var g=new Image;e.add(),g.onload=function(){q.game.cache.addSpriteSheet(r,null,g,s,n),e.ret()},g.src="data:image/png;base64,"+t.bufferToBase64(new Uint8Array(u))}else{e.add();for(var d=new c(e.ret),y=Math.ceil(Math.sqrt(o)),f=q.game.add.bitmapData(y*s,y*n),_=function(e){var o=10>e?"_0"+e:"_"+e,h=q.game.cache.getBinary(i+o+".png");"undefined"!=typeof a&&(h=t.createVariation(h,a),r+="_"+a);var p=new Image;d.add(),p.onload=function(){f.ctx.drawImage(p,e%y*s,Math.floor(e/y)*n),d.ret()},p.src="data:image/png;base64,"+t.bufferToBase64(new Uint8Array(h))},m=0;o>m;m++)_(m);d.await(),q.game.cache.addSpriteSheet(r,null,f.canvas,s,n,o)}},t.loadImage=function(e,i){var s=q.game.cache.getBinary(i+".png"),n=new Image;e.add(),n.onload=function(){q.game.cache.addImage(i,null,n),e.ret()},n.src="data:image/png;base64,"+t.bufferToBase64(new Uint8Array(s))},t.createVariation=function(e,i){if("undefined"==typeof i)return e;e=e.slice(0);for(var s=new DataView(e),n=0,o=0;n<s.byteLength-3;n++)if(80==s.getUint8(n)&&76==s.getUint8(n+1)&&84==s.getUint8(n+2)){o=n-4;break}n=o;var a=s.getUint32(n);n+=4;for(var r=-1,h=0;4>h;h++)r=t.updatePNGCRC(s.getUint8(n+h),r);n+=4;for(var h=n;n+a>h;h+=3){var p=s.getUint8(h),c=s.getUint8(h+1),l=s.getUint8(h+2);if(l>p&&l>c){if(2==i){var u=p;p=l,l=u,c/=2}else 0==i&&(p=l,c=l);s.setUint8(h,p),s.setUint8(h+1,c),s.setUint8(h+2,l)}r=t.updatePNGCRC(s.getUint8(h),r),r=t.updatePNGCRC(s.getUint8(h+1),r),r=t.updatePNGCRC(s.getUint8(h+2),r)}r^=-1;var g=o+8+a;return s.setUint32(g,r),e},t.updatePNGCRC=function(t,e){e^=255&t;for(var i=0;8>i;i++)0==(1&e)?e>>>=1:e=e>>>1^-306674912;return e},t}(),s=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},u=function(t){function e(){t.call(this)}return s(e,t),e.prototype.preload=function(){this.game.scale.scaleMode=Phaser.ScaleManager.USER_SCALE,this.game.scale.setUserScale(2,2),this.game.load.bitmapFont("font7","data/font.png","data/font.xml"),this.game.load.binary("data","data/1.pak",function(t,e){return new Uint8Array(e)}),this.game.load.binary("lang","data/lang.dat",function(t,e){return new Uint8Array(e)})},e.prototype.create=function(){var t=this;this.unpackResourceData(),this.loadEntityData(),this.loadMapTilesProp(),this.unpackLangData();var e=new c(function(){t.game.state.start("MainMenu",!1,!1,name)});l.loadImage(e,"splash"),l.loadImage(e,"splashbg"),l.loadImage(e,"splashfg"),l.loadSpriteSheet(e,"tiles0",24,24),l.loadSpriteSheet(e,"stiles0",10,10),l.loadSpriteSheet(e,"buildings",24,24,3,0),l.loadSpriteSheet(e,"buildings",24,24,3,1),l.loadSpriteSheet(e,"buildings",24,24,3,2),l.loadSpriteSheet(e,"unit_icons",24,24,0,1),l.loadSpriteSheet(e,"unit_icons",24,24,0,2),l.loadSpriteSheet(e,"unit_icons_s",10,10,0,1),l.loadSpriteSheet(e,"unit_icons_s",10,10,0,2),l.loadSpriteSheet(e,"cursor",26,26),l.loadSpriteSheet(e,"b_smoke"),l.loadSpriteSheet(e,"menu"),l.loadSpriteSheet(e,"portrait"),l.loadSpriteSheet(e,"chars"),l.loadImage(e,"gold"),l.loadImage(e,"pointer"),l.loadSpriteSheet(e,"redspark"),l.loadSpriteSheet(e,"spark"),l.loadSpriteSheet(e,"smoke"),l.loadSpriteSheet(e,"status"),l.loadSpriteSheet(e,"road",24,24),l.loadSpriteSheet(e,"grass",24,24),l.loadSpriteSheet(e,"mountain",24,24),l.loadSpriteSheet(e,"water",24,24),l.loadSpriteSheet(e,"town",24,24),l.loadImage(e,"woods_bg"),l.loadImage(e,"hill_bg"),l.loadImage(e,"mountain_bg"),l.loadImage(e,"bridge_bg"),l.loadImage(e,"town_bg"),l.loadImage(e,"tombstone"),l.loadImage(e,"mask"),e.await()},e.prototype.unpackResourceData=function(){var t=this.game.cache.getBinary("data"),e=new DataView(t.buffer),i=2,s=e.getUint16(i);i+=2;for(var n=[],o=0;s>o;o++){var a=e.getUint16(i);i+=2;for(var r="",h=0;a>h;h++)r+=String.fromCharCode(e.getUint8(i++));i+=4;var p=e.getUint16(i);i+=2,n.push({name:r,size:p})}for(var c=0,l=n;c<l.length;c++){var u=l[c],g=t.buffer.slice(i,i+u.size);this.game.cache.addBinary(u.name,g),i+=u.size}},e.prototype.loadEntityData=function(){var t=this.game.cache.getBinary("units.bin"),e=new DataView(t),i=0;q.ENTITIES=[];for(var s=["Soldier","Archer","Lizard","Wizard","Wisp","Spider","Golem","Catapult","Wyvern","King","Skeleton"],n=0;n<s.length;n++){var o={name:s[n],mov:e.getUint8(i++),atk:e.getUint8(i++),def:e.getUint8(i++),max:e.getUint8(i++),min:e.getUint8(i++),cost:e.getUint16(i),battle_positions:[],flags:v.None};i+=2;for(var a=e.getUint8(i++),r=0;a>r;r++)o.battle_positions.push({x:e.getUint8(i++),y:e.getUint8(i++)});for(var h=e.getUint8(i++),r=0;h>r;r++)o.flags|=1<<e.getUint8(i++);q.ENTITIES.push(o)}},e.prototype.loadMapTilesProp=function(){var t=this.game.cache.getBinary("tiles0.prop"),e=new DataView(t),i=0,s=e.getUint16(i);i+=4,q.TILES_PROP=[];for(var n=0;s>n;n++)q.TILES_PROP.push(e.getUint8(i++))},e.prototype.unpackLangData=function(){var t=this.game.cache.getBinary("lang"),e=new DataView(t.buffer),i=0,s=e.getUint32(i);i+=4,q.LANG=[];for(var n=0;s>n;n++){var o=e.getUint16(i);i+=2;for(var a="",r=0;o>r;r++)a+=String.fromCharCode(e.getUint8(i++));q.LANG.push(a)}},e}(Phaser.State);!function(t){t[t.None=0]="None",t[t.Up=1]="Up",t[t.Right=2]="Right",t[t.Down=4]="Down",t[t.Left=8]="Left",t[t.Enter=16]="Enter",t[t.Esc=32]="Esc"}(h||(h={}));var g,d=function(){function t(t){this.all_keys=h.None,this.key_up=t.keyboard.addKey(Phaser.Keyboard.UP),this.key_down=t.keyboard.addKey(Phaser.Keyboard.DOWN),this.key_right=t.keyboard.addKey(Phaser.Keyboard.RIGHT),this.key_left=t.keyboard.addKey(Phaser.Keyboard.LEFT),this.key_enter=t.keyboard.addKey(Phaser.Keyboard.ENTER),this.key_esc=t.keyboard.addKey(Phaser.Keyboard.ESC)}return t.prototype.isKeyPressed=function(t){return 0!=(this.all_keys&t)},t.prototype.clearKeyPressed=function(t){this.all_keys&=~t},t.prototype.update=function(){var t=h.None;t|=this.updateKey(h.Up,this.key_up.isDown),t|=this.updateKey(h.Right,this.key_right.isDown),t|=this.updateKey(h.Down,this.key_down.isDown),t|=this.updateKey(h.Left,this.key_left.isDown),t|=this.updateKey(h.Enter,this.key_enter.isDown),t|=this.updateKey(h.Esc,this.key_esc.isDown),this.last_keys=t},t.prototype.setKey=function(t,e){this.all_keys^=(-e^this.all_keys)&t},t.prototype.wasKeyPressed=function(t){return 0!=(this.last_keys&t)},t.prototype.updateKey=function(t,e){return e!=this.wasKeyPressed(t)&&this.setKey(t,e),e?t:0},t}();!function(t){t[t.None=0]="None",t[t.Show=1]="Show",t[t.Hide=2]="Hide",t[t.Change=4]="Change",t[t.Wire=8]="Wire",t[t.Destroy=16]="Destroy",t[t.Update=32]="Update"}(g||(g={}));var y,f=function(){function t(){this.reuse_tiles=[]}return t.getRect=function(t,e,i,s){return{x:t,y:e,width:i,height:s}},t.copyRect=function(t){return{x:t.x,y:t.y,width:t.width,height:t.height}},t.getTileForDirection=function(t){switch(t){case o.Up:return 4;case o.Up|o.Right:return 1;case o.Right:return 7;case o.Right|o.Down:return 3;case o.Down:return 5;case o.Down|o.Left:return 2;case o.Left:return 6}return 0},t.prototype.initialize=function(t,e,i,s,n,o){this.align=s,this.animation_direction="undefined"!=typeof o?o:s,this.border=n,this.group=i,this.border_group=this.group.game.add.group(),this.group.add(this.border_group),this.border_group.visible=!1,this.border_graphics=this.group.game.add.graphics(0,0,this.border_group),this.content_group=this.group.game.add.group(),this.group.add(this.content_group),this.content_group.visible=!1,this.content_graphics=this.group.game.add.graphics(0,0,this.content_group),this.game_width=this.group.game.width,this.game_height=this.group.game.height,this.width=t,this.height=e,this.animation=g.None,this.current=this.getRetractedRect()},t.prototype.show=function(e,i){void 0===e&&(e=!1),void 0===i&&(i=0),this.animation=g.None,this.target=this.getAlignmentRect(i),e?(this.animation=g.Show,this.animation_direction==o.None&&(this.animation|=g.Wire),this.calculateSpeed()):this.current=t.copyRect(this.target),this.updateOffset(),this.border_group.visible=!0,0!=(this.animation&g.Wire)?(this.removeFrame(),this.content_group.visible=!1):(this.drawFrame(this.width,this.height),this.content_group.visible=!0)},t.prototype.hide=function(e,i,s){return void 0===e&&(e=!1),void 0===i&&(i=!1),void 0===s&&(s=!1),this.animation=g.None,this.target=this.getRetractedRect(),e?(this.animation=g.Hide,i&&(this.animation|=g.Destroy),s&&(this.animation|=g.Update),this.animation_direction==o.None&&(this.animation|=g.Wire,this.content_group.visible=!1,this.removeFrame()),void this.calculateSpeed()):(this.current=t.copyRect(this.target),this.border_group.visible=!1,this.content_group.visible=!1,this.removeTiles(),this.updateOffset(),void(i&&this.destroy()))},t.prototype.updateSize=function(e,i,s){if(void 0===s&&(s=!1),this.width!=e||this.height!=i){if(0!=(this.animation&g.Update))return this.width=e,void(this.height=i);if(this.animation=g.None,!s)return this.width=e,this.height=i,this.target=this.getAlignmentRect(),this.current=t.copyRect(this.target),this.updateOffset(),void this.drawFrame(e,i);var n=this.width,a=this.height;this.width=e,this.height=i,this.animation=g.Change,this.animation_direction==o.None?this.animation|=g.Wire:(e=Math.max(e,n),i=Math.max(i,a),this.current.width=e,this.current.height=i),this.target=this.getAlignmentRect(),0!=(this.align&o.Left)&&(this.current.x-=e-n,this.target.x-=e-this.width),0!=(this.align&o.Up)&&(this.current.y-=i-a,this.target.y-=i-this.height),this.updateOffset(),0!=(this.animation&g.Wire)?this.removeFrame():this.drawFrame(e,i),this.calculateSpeed()}},t.prototype.updateDirections=function(t,e,i,s){void 0===s&&(s=!1),this.new_align===t&&this.new_border==e&&this.new_animation_direction==i&&this.new_animate==s||(this.new_align=t,this.new_border=e,this.new_animation_direction=i,this.new_animate=s,this.hide(!0,!1,!0))},t.prototype.update=function(e){if(this.animation!=g.None){var i=this.addGain("x",e),s=this.addGain("y",e),n=!0,a=!0;if(0!=(this.animation&g.Wire)&&(n=this.addGain("width",e),a=this.addGain("height",e)),i&&s&&n&&a){if(this.animationDidEnd(this.animation),0!=(this.animation&g.Wire)&&(this.border_graphics.clear(),0==(this.animation&g.Hide)&&(this.drawFrame(this.width,this.height),this.content_group.visible=!0)),0!=(this.animation&g.Change)&&(this.target.width=this.width,this.target.height=this.height,0!=(this.align&o.Left)&&(this.target.x=0),0!=(this.align&o.Up)&&(this.target.y=0),this.current=t.copyRect(this.target),this.updateOffset(),this.drawFrame(this.width,this.height)),0!=(this.animation&g.Hide)){if(0!=(this.animation&g.Destroy))return void this.destroy();if(0!=(this.animation&g.Update))return void this.applyDirections();this.hide()}this.animation=g.None}0!=(this.animation&g.Wire)&&(this.border_graphics.clear(),this.border_graphics.lineStyle(1,16777215),this.border_graphics.drawRect(0,0,this.current.width,this.current.height)),this.updateOffset()}},t.prototype.destroy=function(){this.delegate&&this.delegate.frameWillDestroy(this),this.border_group.destroy(!0),this.content_group.destroy(!0)},t.prototype.animationDidEnd=function(t){},t.prototype.applyDirections=function(){this.align=this.new_align,this.border=this.new_border,this.animation_direction=this.new_animation_direction,this.current=this.getRetractedRect(),this.show(this.new_animate)},t.prototype.getAlignmentRect=function(e){void 0===e&&(e=0);var i=t.getRect(0,0,this.width,this.height);return 0!=(this.align&o.Left)?i.x=0:0!=(this.align&o.Right)?i.x=this.game_width-this.width:i.x=Math.floor((this.game_width-this.width)/2),e>0?(i.y=e,i):(0!=(this.align&o.Up)?i.y=0:0!=(this.align&o.Down)?i.y=this.game_height-this.height:i.y=Math.floor((this.game_height-this.height)/2),i)},t.prototype.getRetractedRect=function(){if(this.animation_direction==o.None)return t.getRect(Math.floor(this.game_width/2),Math.floor(this.game_height/2),0,0);var e=this.getAlignmentRect();return 0!=(this.animation_direction&o.Left)&&(e.x=-this.width),0!=(this.animation_direction&o.Right)&&(e.x=this.game_width),0!=(this.animation_direction&o.Up)&&(e.y=-this.height),0!=(this.animation_direction&o.Down)&&(e.y=this.game_height),e},t.prototype.updateOffset=function(){var t=this.current.x,e=this.current.y,i=0,s=0;0!=(this.border&o.Left)&&(i=6),0!=(this.border&o.Up)&&(s=6),this.border_group.x=t,this.border_group.y=e,this.content_group.x=t+i,this.content_group.y=e+s},t.prototype.drawFrame=function(e,i){var s=e,n=i;0!=(this.border&o.Left)&&(s-=6),0!=(this.border&o.Right)&&(s-=6),0!=(this.border&o.Up)&&(n-=6),0!=(this.border&o.Down)&&(n-=6);var a=Math.ceil(e/t.BORDER_SIZE)-2,r=Math.ceil(i/t.BORDER_SIZE)-2;this.content_graphics.clear(),this.content_graphics.lineStyle(0),this.content_graphics.beginFill(13549221),this.content_graphics.drawRect(0,0,s,n),this.content_graphics.endFill();for(var h=[],p=t.BORDER_SIZE,c=0;a>c;c++)this.border&o.Up&&h.push(this.drawBorderTile(p,0,o.Up)),this.border&o.Down&&h.push(this.drawBorderTile(p,i-t.BORDER_SIZE,o.Down)),p+=t.BORDER_SIZE;for(var l=t.BORDER_SIZE,u=0;r>u;u++)this.border&o.Left&&h.push(this.drawBorderTile(0,l,o.Left)),this.border&o.Right&&h.push(this.drawBorderTile(e-t.BORDER_SIZE,l,o.Right)),l+=t.BORDER_SIZE;0!=(this.border&(o.Up|o.Left))&&h.push(this.drawBorderTile(0,0,this.border&(o.Up|o.Left))),0!=(this.border&(o.Up|o.Right))&&h.push(this.drawBorderTile(e-t.BORDER_SIZE,0,this.border&(o.Up|o.Right))),0!=(this.border&(o.Down|o.Left))&&h.push(this.drawBorderTile(0,i-t.BORDER_SIZE,this.border&(o.Down|o.Left))),0!=(this.border&(o.Down|o.Right))&&h.push(this.drawBorderTile(e-t.BORDER_SIZE,i-t.BORDER_SIZE,this.border&(o.Down|o.Right))),this.removeTiles(),this.reuse_tiles=h},t.prototype.removeFrame=function(){this.content_graphics.clear(),this.removeTiles()},t.prototype.drawBorderTile=function(e,i,s){var n;return this.reuse_tiles.length>0?(n=this.reuse_tiles.shift(),n.bringToTop(),n.x=e,n.y=i):n=this.group.game.add.image(e,i,"menu",null,this.border_group),n.frame=t.getTileForDirection(s),n},t.prototype.addGain=function(t,e){if(0==this.speed[t])return!0;this.acc[t]+=this.speed[t]*e;var i=Math.floor(this.acc[t]);return this.current[t]+=i,this.acc[t]-=i,0>i&&this.current[t]<this.target[t]?(this.current[t]=this.target[t],!0):i>0&&this.current[t]>this.target[t]?(this.current[t]=this.target[t],!0):!1},t.prototype.calculateSpeed=function(){this.speed=t.getRect((this.target.x-this.current.x)/t.ANIM_STEPS,(this.target.y-this.current.y)/t.ANIM_STEPS,(this.target.width-this.current.width)/t.ANIM_STEPS,(this.target.height-this.current.height)/t.ANIM_STEPS),this.acc=t.getRect(0,0,0,0)},t.prototype.removeTiles=function(){for(;this.reuse_tiles.length>0;){var t=this.reuse_tiles.shift();t.destroy()}},t.BORDER_SIZE=24,t.ANIM_STEPS=15,t}(),s=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},_=function(t){function e(e,i,s){t.call(this),this.map=e,this.menu_delegate=s,this.slow=0,this.units_visible=!0,this.initialize(e.width*q.MINI_SIZE+12,e.height*q.MINI_SIZE+12,i,o.None,o.All,o.None),this.drawContent()}return s(e,t),e.prototype.show=function(e){void 0===e&&(e=!1),this.menu_delegate&&this.menu_delegate.openMenu(B.Ack),t.prototype.show.call(this,e)},e.prototype.hide=function(e,i,s){void 0===e&&(e=!1),void 0===i&&(i=!1),void 0===s&&(s=!1),this.menu_delegate&&this.menu_delegate.closeMenu(B.Ack),t.prototype.hide.call(this,e,i,s)},e.prototype.update=function(e){if(t.prototype.update.call(this,e),this.slow+=e,this.slow>=30){this.slow-=30,this.units_visible=!this.units_visible;for(var i=0,s=this.entities;i<s.length;i++){var n=s[i];n.visible=this.units_visible}}},e.prototype.drawContent=function(){for(var t=0;t<this.map.width;t++)for(var e=0;e<this.map.height;e++){var i=this.getTileIndexAt(new r(t,e));this.group.game.add.image(t*q.MINI_SIZE,e*q.MINI_SIZE,"stiles0",i,this.content_group)}this.entities=[];for(var s=0,n=this.map.entities;s<n.length;s++){var o=n[s],a=this.group.game.add.image(o.position.x*q.MINI_SIZE,o.position.y*q.MINI_SIZE,"unit_icons_s_"+o.alliance,o.type,this.content_group);this.entities.push(a)}},e.prototype.getTileIndexAt=function(t){var e=this.map.getTileAt(t);switch(e){case M.Path:return 0;case M.Grass:return 1;case M.Forest:return 2;case M.Hill:return 3;case M.Mountain:return 4;case M.Water:return 5;case M.Bridge:return 6;case M.House:case M.Castle:var i=this.map.getAllianceAt(t);return(e==M.Castle?8:7)+2*i}return 0},e}(f),s=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},m=function(t){function e(e,i,s,n){t.call(this,e,i,s),this.keys=n,this.context=[B.Map]}return s(e,t),e.prototype.isPlayer=function(){return!0},e.prototype.start=function(){this.keys.all_keys=h.None},e.prototype.run=function(){if(this.keys.update(),this.keys.all_keys!=h.None)switch(this.context[this.context.length-1]){case B.Map:var t=this.delegate.cursor.world_position.x%24==0&&this.delegate.cursor.world_position.y%24==0;if(this.keys.isKeyPressed(h.Up)&&t&&this.delegate.cursor_target.y>0)this.delegate.cursor_target.move(o.Up);else if(this.keys.isKeyPressed(h.Right)&&t&&this.delegate.cursor_target.x<this.map.width-1)this.delegate.cursor_target.move(o.Right);else if(this.keys.isKeyPressed(h.Down)&&t&&this.delegate.cursor_target.y<this.map.height-1)this.delegate.cursor_target.move(o.Down);else if(this.keys.isKeyPressed(h.Left)&&t&&this.delegate.cursor_target.x>0)this.delegate.cursor_target.move(o.Left);else if(this.keys.isKeyPressed(h.Enter))this.keys.clearKeyPressed(h.Enter),this.pickPosition(this.delegate.cursor_target);else if(this.keys.isKeyPressed(h.Esc)){this.keys.clearKeyPressed(h.Esc);var e=this.selected_entity;if(this.deselectEntity(!1),e&&e.position.match(this.map.getKingPosition(this.alliance))&&e.data.cost<=1e3){var i=this.delegate.getGoldForAlliance(this.alliance);this.delegate.setGoldForAlliance(this.alliance,i+e.data.cost),this.map.removeEntity(e)}}break;case B.Options:if(this.keys.isKeyPressed(h.Up))this.keys.clearKeyPressed(h.Up),this.options_menu.prev();else if(this.keys.isKeyPressed(h.Down))this.keys.clearKeyPressed(h.Down),this.options_menu.next();else if(this.keys.isKeyPressed(h.Enter)){this.keys.clearKeyPressed(h.Enter);var s=this.options_menu.getSelected();this.context.pop(),this.options_menu.hide(!0,!0),this.options_menu=null,this.selectOption(s)}else this.keys.isKeyPressed(h.Esc)&&(this.keys.clearKeyPressed(h.Esc),this.context.pop(),this.options_menu.hide(!0,!0),this.options_menu=null,this.selectOption(L.CANCEL));break;case B.Selection:if(this.keys.isKeyPressed(h.Up)&&this.delegate.cursor_target.y>0){this.keys.clearKeyPressed(h.Up);var e=this.map.nextTargetInRange(o.Up);this.delegate.cursor_target=e.position.copy()}else if(this.keys.isKeyPressed(h.Right)&&this.delegate.cursor_target.x<this.map.width-1){this.keys.clearKeyPressed(h.Right);var e=this.map.nextTargetInRange(o.Right);this.delegate.cursor_target=e.position.copy()}else if(this.keys.isKeyPressed(h.Down)&&this.delegate.cursor_target.y<this.map.height-1){this.keys.clearKeyPressed(h.Down);var e=this.map.nextTargetInRange(o.Down);this.delegate.cursor_target=e.position.copy()}else if(this.keys.isKeyPressed(h.Left)&&this.delegate.cursor_target.x>0){this.keys.clearKeyPressed(h.Left);var e=this.map.nextTargetInRange(o.Left);this.delegate.cursor_target=e.position.copy()}else if(this.keys.isKeyPressed(h.Enter)){this.keys.clearKeyPressed(h.Enter),this.delegate.cursor.show(),this.context.pop();var e=this.map.nextTargetInRange(o.None);this.pickEntity(e)}else if(this.keys.isKeyPressed(h.Esc)){this.keys.clearKeyPressed(h.Esc),this.delegate.cursor_target=this.selected_entity.position.copy(),this.delegate.cursor.show(),this.context.pop();var e=this.selected_entity;this.delegate.deselectEntity(!1),this.selectEntity(e)}break;case B.Shop:if(this.keys.isKeyPressed(h.Up))this.keys.clearKeyPressed(h.Up),this.shop_units.prev(!0),this.shop_info.updateContent(this.shop_units.getSelected());else if(this.keys.isKeyPressed(h.Right))this.keys.clearKeyPressed(h.Right),this.shop_units.next(!1),this.shop_info.updateContent(this.shop_units.getSelected());else if(this.keys.isKeyPressed(h.Down))this.keys.clearKeyPressed(h.Down),this.shop_units.next(!0),this.shop_info.updateContent(this.shop_units.getSelected());else if(this.keys.isKeyPressed(h.Left))this.keys.clearKeyPressed(h.Left),this.shop_units.prev(!1),this.shop_info.updateContent(this.shop_units.getSelected());else if(this.keys.isKeyPressed(h.Enter)){this.keys.clearKeyPressed(h.Enter);var n=this.shop_units.getSelected(),e=this.delegate.buyEntity(this.selected_entity,n);e&&(this.deselectEntity(!1),this.closeShop(),this.selectEntity(e))}else this.keys.isKeyPressed(h.Esc)&&(this.keys.clearKeyPressed(h.Esc),
this.deselectEntity(!1),this.closeShop());break;case B.Ack:this.keys.isKeyPressed(h.Enter)?(this.keys.clearKeyPressed(h.Enter),this.fullscreen_group?(this.fullscreen_group.destroy(!0),this.fullscreen_group=null,this.context.pop()):this.closeMap()):this.keys.isKeyPressed(h.Esc)&&(this.keys.clearKeyPressed(h.Esc),this.fullscreen_group?(this.fullscreen_group.destroy(!0),this.fullscreen_group=null,this.context.pop()):this.closeMap());break;case B.Instructions:if(this.keys.isKeyPressed(h.Enter)){if(this.keys.clearKeyPressed(h.Enter),!this.fullscreen_group)break;var a=this.instruction_nr+1;17>=a&&(this.instruction_nr=a,J.showInstructions(this.fullscreen_group,a))}else if(this.keys.isKeyPressed(h.Right)){if(this.keys.clearKeyPressed(h.Right),!this.fullscreen_group)break;var a=this.instruction_nr+1;17>=a&&(this.instruction_nr=a,J.showInstructions(this.fullscreen_group,a))}else if(this.keys.isKeyPressed(h.Left)){if(this.keys.clearKeyPressed(h.Left),!this.fullscreen_group)break;var r=this.instruction_nr-1;r>=0&&(this.instruction_nr=r,J.showInstructions(this.fullscreen_group,r))}else if(this.keys.isKeyPressed(h.Esc)){if(this.keys.clearKeyPressed(h.Esc),!this.fullscreen_group)break;this.fullscreen_group.destroy(!0),this.fullscreen_group=null,this.context.pop()}}},e.prototype.openMenu=function(t){t==B.Wait?this.context.push(t):t==B.Shop?this.delegate.hideInfo(!1):this.delegate.hideInfo(!0)},e.prototype.closeMenu=function(t){t==B.Wait&&t==this.context[this.context.length-1]&&this.context.pop();var e=this.context[this.context.length-1];switch(e){case B.Map:case B.Selection:this.delegate.showInfo(!0);break;case B.Shop:this.delegate.showInfo(!1)}},e.prototype.entityDidMove=function(t){var e=this.map.getEntityOptions(t,!0);e.length<1||this.showOptionMenu(e)},e.prototype.entityDidAnimation=function(t){this.context.pop(),this.selected_entity.updateState(I.Moved,!0),this.deselectEntity(!0)},e.prototype.selectEntity=function(t){var e=this.map.getEntityOptions(t,!1);if(e.length<1)return!1;if(this.selected_entity){if(this.selected_entity!=t)return!1}else this.selected_entity=t,this.delegate.selectEntity(t);return e.length>1?this.showOptionMenu(e):this.selectOption(e[0]),!0},e.prototype.deselectEntity=function(t){this.delegate.deselectEntity(t),this.last_entity_position=null,this.selected_entity=null},e.prototype.showOptionMenu=function(t){this.options_menu=new K(this.delegate.frame_manager.group,o.Right,t,this),this.delegate.frame_manager.addFrame(this.options_menu),this.options_menu.show(!0),this.context.push(B.Options)},e.prototype.showMainMenu=function(t){this.options_menu=new K(this.delegate.frame_manager.group,o.None,t,this,o.Up),this.delegate.frame_manager.addFrame(this.options_menu),this.options_menu.show(!0),this.context.push(B.Options)},e.prototype.selectOption=function(t){switch(t){case L.OCCUPY:this.delegate.occupy(this.selected_entity.position,this.selected_entity.alliance),this.selected_entity.updateState(I.Moved,!0),this.deselectEntity(!0);break;case L.ATTACK:this.context.push(B.Selection),this.delegate.showRange(A.Attack,this.selected_entity),this.delegate.cursor_target=this.map.nextTargetInRange(o.None).position.copy(),this.delegate.cursor.hide();break;case L.RAISE:this.context.push(B.Selection),this.delegate.showRange(A.Raise,this.selected_entity),this.delegate.cursor_target=this.map.nextTargetInRange(o.None).position.copy();break;case L.MOVE:this.delegate.showRange(A.Move,this.selected_entity);break;case L.BUY:this.openShop(this.selected_entity.alliance);break;case L.END_MOVE:this.selected_entity.updateState(I.Moved,!0),this.deselectEntity(!0);break;case L.END_TURN:this.delegate.nextTurn();break;case L.MAIN_MENU:this.showMainMenu(K.getMainMenuOptions(!0));break;case L.MAP:this.openMap();break;case L.SAVE_GAME:this.delegate.saveGame();break;case L.LOAD_GAME:this.delegate.loadGame();break;case L.EXIT:this.delegate.exitGame();break;case L.ABOUT:this.context.push(B.Ack),this.fullscreen_group=J.showAbout(this.delegate.game);break;case L.INSTRUCTIONS:this.context.push(B.Instructions),this.fullscreen_group=this.delegate.game.add.group(),this.fullscreen_group.fixedToCamera=!0,this.instruction_nr=0,J.showInstructions(this.fullscreen_group);break;case L.CANCEL:this.last_entity_position?(this.delegate.cursor_target=this.selected_entity.position,this.delegate.moveEntity(this.selected_entity,this.last_entity_position,!1),this.last_entity_position=null,this.delegate.showRange(A.Move,this.selected_entity)):this.deselectEntity(!1);break;default:console.log("Action "+K.getOptionString(t)+" not yet implemented")}},e.prototype.pickEntity=function(t){switch(this.context.push(B.Animation),this.map.getTypeOfRange()){case A.Attack:this.delegate.attackEntity(this.selected_entity,t);break;case A.Raise:this.delegate.raiseEntity(this.selected_entity,t)}this.delegate.hideRange(),this.delegate.cursor.show()},e.prototype.pickPosition=function(t){if(this.selected_entity)switch(this.map.getTypeOfRange()){case A.Move:this.last_entity_position=this.selected_entity.position.copy(),this.delegate.moveEntity(this.selected_entity,t,!0)}else{var e=this.map.getEntityAt(t);if(e){var i=this.selectEntity(e);if(i)return}this.showOptionMenu(K.getOffMenuOptions())}},e.prototype.openShop=function(t){this.context.push(B.Shop),this.shop_units||(this.shop_units=new V(this.delegate.frame_manager.group,this),this.delegate.frame_manager.addFrame(this.shop_units)),this.shop_units.updateContent(t,this.delegate.getGoldForAlliance(t)),this.shop_units.show(!0),this.shop_info=new z(this.delegate.frame_manager.group,t),this.shop_info.updateContent(k.Soldier),this.delegate.frame_manager.addFrame(this.shop_info),this.shop_info.show(!0)},e.prototype.closeShop=function(){this.context.pop(),this.shop_units.hide(!0,!0),this.shop_units=null,this.shop_info.hide(!0,!0),this.shop_info=null},e.prototype.openMap=function(){this.context.push(B.Ack),this.mini_map=new _(this.map,this.delegate.frame_manager.group,this),this.delegate.frame_manager.addFrame(this.mini_map),this.mini_map.show(!0)},e.prototype.closeMap=function(){this.context.pop(),this.mini_map.hide(!0,!0),this.mini_map=null},e}(n),s=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)};!function(t){t[t.Attack=0]="Attack",t[t.Status=1]="Status",t[t.Raise=2]="Raise"}(y||(y={}));var v,w=function(){function t(t,e,i){this.progress=0,this.current_step=-1,this.steps=t,this.acc=0,this.delegate=i,this.entity=e}return t.prototype.step=function(t,e,i){},t.prototype.run=function(t){if(this.acc+=t,!(this.acc<5)){this.acc-=5;for(var e=0;e<this.steps.length&&!(this.progress<this.steps[e]);)e++;var i=!1;e>this.current_step&&(this.current_step=e,i=!0);var s=this.current_step>0?this.progress-this.steps[this.current_step-1]:this.progress;this.progress++,this.step(i,this.current_step,s)}},t}(),E=function(t){function e(e,i,s,n,o){t.call(this,[6,8],e,i),this.type=y.Attack,this.first=o,this.attacker=n,this.group=s}return s(e,t),e.prototype.step=function(t,e,i){var s=this.entity.position.getWorldPosition();switch(e){case 0:t&&(this.image=this.group.game.add.image(s.x,s.y,"redspark",0,this.group)),this.image.frame=i%3,this.entity.setWorldPosition({x:s.x+2-i%2*4,y:s.y});break;case 1:t&&(this.image.visible=!1),this.entity.setWorldPosition({x:s.x+2-i%2*4,y:s.y});break;case 2:this.entity.setWorldPosition(this.entity.position.getWorldPosition()),this.image.destroy(),this.delegate.animationDidEnd(this)}},e}(w),S=function(t){function e(e,i,s,n){t.call(this,1==n?[0,6,14]:[10,16,24],e,i),this.type=y.Status,this.status=n,this.group=s}return s(e,t),e.prototype.step=function(t,e,i){var s=this.entity.position.getWorldPosition();switch(e){case 0:break;case 1:t&&(0!=this.status&&2!=this.status||(this.image2=this.group.game.add.image(s.x+4,s.y+4,"status",this.status,this.group)),this.image=this.group.game.add.image(s.x,s.y,"spark",0,this.group)),this.image.frame=i;break;case 2:this.status<0?(t&&(this.image.loadTexture("smoke",0),this.entity.updateState(I.Dead,!0)),this.image.y=s.y-3*i,this.image.frame=Math.floor(i/2)):t&&this.image.destroy();break;case 3:this.status<0?this.image.destroy():0!=this.status&&2!=this.status||this.image2.destroy(),this.delegate.animationDidEnd(this),this.delegate.animationDidEnd(this)}},e}(w),T=function(t){function e(e,i,s,n){t.call(this,[8,18],e,i),this.type=y.Raise,this.group=s,this.new_alliance=n,this.images=[]}return s(e,t),e.prototype.step=function(t,e,i){var s=this.entity.position.getWorldPosition();switch(e){case 0:t&&(this.images.push(this.group.game.add.image(s.x-8,s.y-8,"spark",0,this.group)),this.images.push(this.group.game.add.image(s.x+8,s.y-8,"spark",0,this.group)),this.images.push(this.group.game.add.image(s.x-8,s.y+8,"spark",0,this.group)),this.images.push(this.group.game.add.image(s.x+8,s.y+8,"spark",0,this.group)));var n=8-i;this.images[0].frame=i%6,this.images[0].x=s.x-n,this.images[0].y=s.y-n,this.images[1].frame=i%6,this.images[1].x=s.x+n,this.images[1].y=s.y-n,this.images[2].frame=i%6,this.images[2].x=s.x-n,this.images[2].y=s.y+n,this.images[3].frame=i%6,this.images[3].x=s.x+n,this.images[3].y=s.y+n;break;case 1:t&&this.entity.raise(this.new_alliance);var o=-i;this.images[0].frame=(i+2)%6,this.images[0].x=s.x-o,this.images[0].y=s.y-o,this.images[1].frame=(i+2)%6,this.images[1].x=s.x+o,this.images[1].y=s.y-o,this.images[2].frame=(i+2)%6,this.images[2].x=s.x-o,this.images[2].y=s.y+o,this.images[3].frame=(i+2)%6,this.images[3].x=s.x+o,this.images[3].y=s.y+o;break;case 2:this.images[0].destroy(),this.images[1].destroy(),this.images[2].destroy(),this.images[3].destroy(),this.delegate.animationDidEnd(this)}},e}(w),s=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)};!function(t){t[t.None=0]="None",t[t.CanFly=1]="CanFly",t[t.WaterBoost=2]="WaterBoost",t[t.CanBuy=4]="CanBuy",t[t.CanOccupyHouse=8]="CanOccupyHouse",t[t.CanOccupyCastle=16]="CanOccupyCastle",t[t.CanRaise=32]="CanRaise",t[t.AntiFlying=64]="AntiFlying",t[t.CanPoison=128]="CanPoison",t[t.CanWisp=256]="CanWisp",t[t.CantAttackAfterMoving=512]="CantAttackAfterMoving"}(v||(v={}));var k;!function(t){t[t.Soldier=0]="Soldier",t[t.Archer=1]="Archer",t[t.Lizard=2]="Lizard",t[t.Wizard=3]="Wizard",t[t.Wisp=4]="Wisp",t[t.Spider=5]="Spider",t[t.Golem=6]="Golem",t[t.Catapult=7]="Catapult",t[t.Wyvern=8]="Wyvern",t[t.King=9]="King",t[t.Skeleton=10]="Skeleton"}(k||(k={}));var x;!function(t){t[t.None=0]="None",t[t.Poisoned=1]="Poisoned",t[t.Wisped=2]="Wisped"}(x||(x={}));var I;!function(t){t[t.Ready=0]="Ready",t[t.Moved=1]="Moved",t[t.Dead=2]="Dead"}(I||(I={}));var A,b=function(t){function e(e,i,s){t.call(this),this.atk_boost=0,this.def_boost=0,this.mov_boost=0,this.data=q.ENTITIES[e],this.alliance=i,this.type=e,this.position=s,this.death_count=0,this.health=10,this.rank=0,this.ep=0,this.status=0,this.state=I.Ready,this.status_animation=-1}return s(e,t),e.prototype.init=function(e){t.prototype.init.call(this,this.position.getWorldPosition(),e,"unit_icons_"+this.alliance,[this.type,this.type+q.ENTITIES.length]),this.icon_moved=e.game.add.image(0,0,"chars",4,e),this.icon_moved.visible=!1,this.icon_health=e.game.add.image(0,0,"chars",0,e),this.icon_health.visible=!1},e.prototype.isDead=function(){return 0==this.health},e.prototype.hasFlag=function(t){return 0!=(this.data.flags&t)},e.prototype.getDistanceToEntity=function(t){return this.position.distanceTo(t.position)},e.prototype.shouldRankUp=function(){return this.rank<3&&this.ep>=75<<this.rank?(this.ep=0,this.rank++,!0):!1},e.prototype.attack=function(t,e){var i,s=this.data.atk+this.atk_boost;this.type==k.Archer&&t.type==k.Wyvern&&(s+=2),this.type==k.Wisp&&t.type==k.Skeleton&&(s+=3),i=Math.floor(39*Math.random())-19+this.rank,i>=19?s+=2:i>=17?s+=1:-19>=i?s-=2:-17>=i&&(s-=1);var n=t.data.def+t.def_boost;i=Math.floor(39*Math.random())-19+t.rank,i>=19?n+=2:i>=17?n+=1:-19>=i?n-=2:-17>=i&&(n-=1);var o=Math.floor((s-(n+e.getDefAt(t.position,t.type))*(2/3))*this.health/10);o>t.health&&(o=t.health),t.setHealth(t.health-o),this.ep+=(t.data.atk+t.data.def)*o},e.prototype.updateStatus=function(){this.atk_boost=0,this.def_boost=0,this.mov_boost=0,this.status&x.Poisoned&&(this.atk_boost--,this.def_boost--,this.mov_boost--),this.status&x.Wisped&&this.atk_boost++},e.prototype.setStatus=function(t){this.status|=t,this.updateStatus()},e.prototype.clearStatus=function(t){this.status&=~t,this.updateStatus()},e.prototype.getPowerEstimate=function(t,e){return Math.floor((this.rank+this.data.atk+this.data.def+e.getDefAt(t,this.type))*this.health)},e.prototype.updateState=function(t,e){this.state=t,t==I.Dead?(this.sprite.loadTexture("tombstone",0),this.setFrames([0])):(this.sprite.loadTexture("unit_icons_"+this.alliance,this.type),this.setFrames([this.type,this.type+q.ENTITIES.length]));var i=e&&t==I.Moved;this.icon_moved.x=this.sprite.x+q.TILE_SIZE-7,this.icon_moved.y=this.sprite.y+q.TILE_SIZE-7,this.icon_moved.visible=i,this.icon_moved.bringToTop()},e.prototype.startAnimation=function(t){this.animation=t},e.prototype.move=function(t,e,i){this.path={progress:0,line:e,delegate:i,target:t}},e.prototype.update=function(e){if(void 0===e&&(e=1),t.prototype.update.call(this,e),this.path)if(this.path.progress+=e,this.path.line.length>0&&this.path.progress>=this.path.line[0].length*q.TILE_SIZE&&(this.path.progress-=this.path.line[0].length*q.TILE_SIZE,this.path.line.shift()),this.path.line.length>0){var i=new r(0,0).move(this.path.line[0].direction);this.world_position.x=this.path.line[0].position.x*q.TILE_SIZE+i.x*this.path.progress,this.world_position.y=this.path.line[0].position.y*q.TILE_SIZE+i.y*this.path.progress}else{this.position=this.path.target,this.world_position=this.path.target.getWorldPosition();var s=this.path.delegate;this.path=null,s.entityDidMove(this)}else this.animation&&this.animation.run(e);this.icon_health.x=this.sprite.x,this.icon_health.y=this.sprite.y+q.TILE_SIZE-7},e.prototype.setHealth=function(t){return this.health=t,t>9||1>t?void(this.icon_health.visible=!1):(this.icon_health.visible=!0,this.icon_health.frame=27+(t-1),this.icon_health.x=this.sprite.x,void(this.icon_health.y=this.sprite.y+q.TILE_SIZE-7))},e.prototype.raise=function(t){this.type=k.Skeleton,this.alliance=t,this.rank=0,this.ep=0,this.death_count=0,this.setHealth(10),this.clearStatus(x.Poisoned),this.clearStatus(x.Wisped),this.updateState(I.Moved,!0)},e.prototype.getMovement=function(){return this.data.mov+this.mov_boost},e.prototype.shouldCounter=function(t){return this.health>0&&this.position.distanceTo(t)<2&&this.data.min<2},e.prototype.destroy=function(){this.icon_health.destroy(),this.icon_moved.destroy(),t.prototype.destroy.call(this)},e.prototype["export"]=function(){return{type:this.type,alliance:this.alliance,x:this.position.x,y:this.position.y,rank:this.rank,ep:this.ep,state:this.state,status:this.status,health:this.health,death_count:this.death_count}},e}(p);!function(t){t[t.None=0]="None",t[t.Move=1]="Move",t[t.Attack=2]="Attack",t[t.Raise=3]="Raise"}(A||(A={}));var M,R=function(){function t(t){this.map=t,this.type=A.None}return t.findPositionInList=function(t,e){for(var i=0,s=e;i<s.length;i++){var n=s[i];if(n.position.match(t))return n}return null},t.getLineToWaypoint=function(t){for(var e=[];null!=t.parent;){var i=t;t=t.parent;var s=t.position.getDirectionTo(i.position);e.length>0&&e[0].direction==s?(e[0].position=t.position,e[0].length++):e.unshift({position:t.position,direction:s,length:1})}return e},t.prototype.init=function(t){this.extra_cursor=new p,this.extra_cursor.init({x:0,y:0},t,"cursor",[4]),this.extra_cursor.hide()},t.prototype.getWaypointAt=function(e){return t.findPositionInList(e,this.waypoints)},t.prototype.sort=function(){this.waypoints.sort(function(t,e){return t.position.x==e.position.x?t.position.y-e.position.y:t.position.x-e.position.x})},t.prototype.createRange=function(t,e,i){switch(this.type=t,this.targets_x=i,this.targets_y=null,this.target=null,this.range_lighten=!1,this.range_progress=100,this.line_end_position=null,this.line_slow=0,this.line_offset=0,t){case A.Raise:this.waypoints=[{position:e.position.copy(o.Up),cost:0,form:o.All,parent:null},{position:e.position.copy(o.Right),cost:0,form:o.All,parent:null},{position:e.position.copy(o.Down),cost:0,form:o.All,parent:null},{position:e.position.copy(o.Left),cost:0,form:o.All,parent:null}],this.extra_cursor.hide();break;case A.Attack:var s=e.data.min,n=e.data.max;this.waypoints=this.calculateWaypoints(e.position,e.alliance,e.type,n,!1);for(var a=this.waypoints.length-1;a>=0;a--){var r=this.waypoints[a];r.cost<s&&this.waypoints.splice(a,1)}this.addForm(),this.extra_cursor.setFrames([2,3]),this.extra_cursor.setOffset(-1,-1),this.extra_cursor.show();break;case A.Move:this.waypoints=this.calculateWaypoints(e.position,e.alliance,e.type,e.getMovement(),!e.hasFlag(v.CanFly)),this.addForm(),this.extra_cursor.setFrames([4]),this.extra_cursor.setOffset(-1,-4),this.extra_cursor.show()}},t.prototype.nextTargetInRange=function(t){if(this.targets_x.length<1)return null;if(this.targets_y||this.sortTargets(),t==o.None)return this.target;var e=new r(0,0).move(t);if(0!=e.x){var i=this.targets_x.indexOf(this.target);return i+=e.x,0>i?i=this.targets_x.length-1:i>=this.targets_x.length&&(i=0),this.target=this.targets_x[i],this.target}var s=this.targets_y.indexOf(this.target);return s+=e.y,0>s?s=this.targets_y.length-1:s>=this.targets_y.length&&(s=0),this.target=this.targets_y[s],this.target},t.prototype.selectTarget=function(t){return this.getWaypointAt(t.position)?(this.target=t,!0):!1},t.prototype.sortTargets=function(){this.targets_y=this.targets_x.slice(),this.targets_x.sort(function(t,e){return t.position.x==e.position.x?t.position.y-e.position.y:t.position.x-e.position.x}),this.targets_y.sort(function(t,e){return t.position.y==e.position.y?t.position.x-e.position.x:t.position.y-e.position.y}),this.target=this.targets_x.length>0?this.targets_x[this.targets_x.length-1]:null},t.prototype.draw=function(t){var e;switch(this.type){case A.Move:case A.Raise:e=16777215;break;case A.Attack:e=16711680}t.clear(),t.beginFill(e);for(var i=0,s=this.waypoints;i<s.length;i++){var n=s[i],a=n.position.getWorldPosition();0!=(n.form&o.Up)&&t.drawRect(a.x,a.y,q.TILE_SIZE,4),0!=(n.form&o.Right)&&t.drawRect(a.x+q.TILE_SIZE-4,a.y,4,q.TILE_SIZE),0!=(n.form&o.Down)&&t.drawRect(a.x,a.y+q.TILE_SIZE-4,q.TILE_SIZE,4),0!=(n.form&o.Left)&&t.drawRect(a.x,a.y,4,q.TILE_SIZE)}t.endFill()},t.prototype.update=function(e,i,s,n,o){if(this.type!=A.None){if(this.range_lighten?(this.range_progress+=e,this.range_progress>=100&&(this.range_progress=100,this.range_lighten=!1)):(this.range_progress-=e,this.range_progress<=40&&(this.range_progress=40,this.range_lighten=!0)),this.extra_cursor.setFrame(s),!i.match(this.line_end_position)){this.line_end_position=i.copy();var a=this.getWaypointAt(i);a&&(this.extra_cursor.setWorldPosition(i.getWorldPosition()),this.line=t.getLineToWaypoint(a))}if(this.type==A.Move&&(this.line_slow+=e,this.line_slow>=5&&(this.line_slow-=5,this.line_offset-=1,this.line_offset<0&&(this.line_offset=q.LINE_SEGMENT_LENGTH+q.LINE_SEGMENT_SPACING-1),this.line))){o.clear(),o.beginFill(16777215);for(var r=0,h=this.line;r<h.length;r++){var p=h[r];this.drawSegment(o,p,this.line_offset),this.line_offset=(this.line_offset+p.length*q.TILE_SIZE)%(q.LINE_SEGMENT_LENGTH+q.LINE_SEGMENT_SPACING)}o.endFill()}var c=this.range_progress/100*255|0;n.tint=c<<16|c<<8|c}},t.prototype.clear=function(t,e){this.type=A.None,this.waypoints=[],this.extra_cursor.hide(),t.clear(),e.clear()},t.prototype.calculateWaypoints=function(t,e,i,s,n){for(var o=[{position:t,cost:n?1:0,form:0,parent:null}],a=[];o.length>0;){var r=o.shift();a.push(r);for(var h=this.map.getAdjacentPositionsAt(r.position),p=0,c=h;p<c.length;p++){var l=c[p];this.checkPosition(l,r,o,a,s,n,e,i)}}return a},t.prototype.checkPosition=function(e,i,s,n,o,a,r,h){if(t.findPositionInList(e,n))return!1;if(a){var p=this.map.getEntityAt(e);if(p&&!p.isDead()&&p.alliance!=r)return!1}var c=1;a&&(c=this.map.getCostAt(e,h));var l=i.cost+c;if(l>o)return!1;var u=t.findPositionInList(e,s);return u?u.cost<=l?!1:(u.cost=l,u.parent=i,!0):(s.push({position:e,parent:i,form:0,cost:l}),!0)},t.prototype.addForm=function(){for(var t=0,e=this.waypoints;t<e.length;t++){var i=e[t];i.form=0,i.position.y>0&&!this.getWaypointAt(i.position.copy(o.Up))&&(i.form+=1),i.position.x<this.map.width-1&&!this.getWaypointAt(i.position.copy(o.Right))&&(i.form+=2),i.position.y<this.map.height-1&&!this.getWaypointAt(i.position.copy(o.Down))&&(i.form+=4),i.position.x>0&&!this.getWaypointAt(i.position.copy(o.Left))&&(i.form+=8)}},t.prototype.drawSegment=function(t,e,i){for(var s=e.length*q.TILE_SIZE,n=(e.position.x+.5)*q.TILE_SIZE,a=(e.position.y+.5)*q.TILE_SIZE;s>0;){var r=q.LINE_SEGMENT_LENGTH;switch(i>0&&(r-=i,i=0),r>s&&(r=s),e.direction){case o.Up:r>0&&t.drawRect(n-q.LINE_SEGMENT_WIDTH/2,a-r,q.LINE_SEGMENT_WIDTH,r),a-=r+q.LINE_SEGMENT_SPACING;break;case o.Right:r>0&&t.drawRect(n,a-q.LINE_SEGMENT_WIDTH/2,r,q.LINE_SEGMENT_WIDTH),n+=r+q.LINE_SEGMENT_SPACING;break;case o.Down:r>0&&t.drawRect(n-q.LINE_SEGMENT_WIDTH/2,a,q.LINE_SEGMENT_WIDTH,r),a+=r+q.LINE_SEGMENT_SPACING;break;case o.Left:r>0&&t.drawRect(n-r,a-q.LINE_SEGMENT_WIDTH/2,r,q.LINE_SEGMENT_WIDTH),n-=r+q.LINE_SEGMENT_SPACING}s-=r+q.LINE_SEGMENT_SPACING}},t}();!function(t){t[t.Path=0]="Path",t[t.Grass=1]="Grass",t[t.Forest=2]="Forest",t[t.Hill=3]="Hill",t[t.Mountain=4]="Mountain",t[t.Water=5]="Water",t[t.Bridge=6]="Bridge",t[t.House=7]="House",t[t.Castle=8]="Castle"}(M||(M={}));var N,P=function(){function t(t){this.name=t,this.entity_range=new R(this),this.load()}return t.getTileForCode=function(t){return q.TILES_PROP[t]},t.getCostForTile=function(t,e){if(t==M.Water&&e==k.Lizard)return 1;var i=0;return i=t==M.Mountain||t==M.Water?3:t==M.Forest||t==M.Hill?2:1,e==k.Lizard?2*i:i},t.getDefForTile=function(t,e){return t==M.Mountain||t==M.House||t==M.Castle?3:t==M.Forest||t==M.Hill?2:t==M.Water&&"undefined"!=typeof e&&e==k.Lizard?2:t==M.Grass?1:0},t.prototype.load=function(){if(!q.game.cache.checkBinaryKey(this.name))return console.log("Could not find map: "+this.name),!1;this.buildings=[],this.entities=[],this.tiles=[];var e=q.game.cache.getBinary(this.name),i=new DataView(e),s=0;this.width=i.getUint32(s),s+=4,this.height=i.getUint32(s),s+=4;for(var n=0;n<this.width;n++){this.tiles[n]=[];for(var o=0;o<this.height;o++){var a=i.getUint8(s++),h=t.getTileForCode(a);this.tiles[n][o]=h,h!=M.House&&h!=M.Castle||this.buildings.push({castle:h==M.Castle,position:new r(n,o),alliance:Math.floor((a-q.NUMBER_OF_TILES)/3)})}}var p=i.getUint32(s);s+=4+4*p;var c=i.getUint32(s);s+=4;for(var l=0;c>l;l++){var u=i.getUint8(s++),g=u%11,d=Math.floor(u/11)+1,n=Math.floor(i.getUint16(s)/16);s+=2;var o=Math.floor(i.getUint16(s)/16);s+=2,this.entities.push(new b(g,d,new r(n,o)))}},t.prototype.importEntities=function(t){this.entities=[];for(var e=0,i=t;e<i.length;e++){var s=i[e],n=this.createEntity(s.type,s.alliance,new r(s.x,s.y));n.health=s.health,n.state=s.state,n.status=s.status,n.ep=s.ep,n.rank=s.rank,n.death_count=s.death_count}},t.prototype.importBuildings=function(t){for(var e=0,i=t;e<i.length;e++){var s=i[e],n=this.getBuildingAt(new r(s.x,s.y));n&&(n.alliance=s.alliance)}},t.prototype.exportEntities=function(){for(var t=[],e=0,i=this.entities;e<i.length;e++){var s=i[e];t.push(s["export"]())}return t},t.prototype.exportBuildings=function(){for(var t=[],e=0,i=this.buildings;e<i.length;e++){var s=i[e];s.alliance!=N.None&&t.push({x:s.position.x,y:s.position.y,alliance:s.alliance})}return t},t.prototype.createEntity=function(t,e,i){var s=new b(t,e,i);return this.entities.push(s),s},t.prototype.removeEntity=function(t){for(var e=0;e<this.entities.length;e++)if(t==this.entities[e]){this.entities.splice(e,1);break}t.destroy()},t.prototype.getEntityAt=function(t){for(var e=0,i=this.entities;e<i.length;e++){var s=i[e];if(s.position.match(t))return s}return null},t.prototype.getKingPosition=function(t){for(var e=0,i=this.entities;e<i.length;e++){var s=i[e];if(s.alliance==t&&s.type==k.King)return s.position.copy()}return null},t.prototype.getEntitiesWith=function(t,e,i){for(var s=[],n=0,o=this.entities;n<o.length;n++){var a=o[n];a.alliance==t&&("undefined"!=typeof i&&a.type!=i||"undefined"!=typeof e&&a.state!=e||"undefined"==typeof e&&a.state==I.Dead||s.push(a))}return s},t.prototype.countEntitiesWith=function(t,e,i){return this.getEntitiesWith(t,e,i).length},t.prototype.nextTurn=function(t){for(var e=this.entities.length-1;e>=0;e--){var i=this.entities[e];if(i.isDead())i.death_count++,i.death_count>=q.DEATH_COUNT&&this.removeEntity(i);else{if(i.alliance==t){if(i.state=I.Ready,this.getAllianceAt(i.position)==i.alliance){var s=Math.min(i.health+2,10);i.setHealth(s)}}else i.state=I.Moved,i.clearStatus(x.Poisoned);var n=i.alliance==t;i.updateState(i.state,n)}}},t.prototype.getTileAt=function(t){return this.tiles[t.x][t.y]},t.prototype.getAdjacentTilesAt=function(t){return[t.y>0?this.getTileAt(new r(t.x,t.y-1)):-1,t.x<this.width-1?this.getTileAt(new r(t.x+1,t.y)):-1,t.y<this.height-1?this.getTileAt(new r(t.x,t.y+1)):-1,t.x>0?this.getTileAt(new r(t.x-1,t.y)):-1]},t.prototype.getAdjacentPositionsAt=function(t){var e=[];return t.y>0&&e.push(new r(t.x,t.y-1)),t.x<this.width-1&&e.push(new r(t.x+1,t.y)),t.y<this.height-1&&e.push(new r(t.x,t.y+1)),t.x>0&&e.push(new r(t.x-1,t.y)),e},t.prototype.setAllianceAt=function(t,e){for(var i=0,s=this.buildings;i<s.length;i++){var n=s[i];if(n.position.match(t))return n.alliance=e,!0}return!1},t.prototype.getBuildingAt=function(t){for(var e=0,i=this.buildings;e<i.length;e++){var s=i[e];if(s.position.match(t))return s}return null},t.prototype.getAllianceAt=function(t){var e=this.getBuildingAt(t);return e?e.alliance:N.None},t.prototype.getOccupiedHouses=function(){for(var t=[],e=0,i=this.buildings;e<i.length;e++){var s=i[e];s.castle||s.alliance==N.None||t.push(s)}return t},t.prototype.getNearestHouseForEntity=function(t){for(var e=-1,i=null,s=0,n=this.buildings;s<n.length;s++){var o=n[s];if(!o.castle){var a=Math.abs(o.position.x-t.position.x)+Math.abs(o.position.y-t.position.y);e>=0&&a>=e||(2==this.getMap()||t.type==k.Soldier&&o.alliance!=t.alliance||t.type!=k.Soldier&&o.alliance==t.alliance)&&(e=a,i=o)}}return i},t.prototype.getGoldGainForAlliance=function(t){for(var e=0,i=0,s=this.buildings;i<s.length;i++){var n=s[i];n.alliance==t&&(e+=n.castle?50:30)}return e},t.prototype.getCostAt=function(e,i){return t.getCostForTile(this.getTileAt(e),i)},t.prototype.getDefAt=function(e,i){return t.getDefForTile(this.getTileAt(e),i)},t.prototype.isCampaign=function(){return"m"==this.name.charAt(0)},t.prototype.getMap=function(){return parseInt(this.name.charAt(1),10)},t.prototype.getEntityOptions=function(t,e){if(void 0===e&&(e=!1),t.state!=I.Ready)return[];if(this.getEntityAt(t.position)!=t)return[L.MOVE];var i=[];if(!e&&t.hasFlag(v.CanBuy)&&this.getTileAt(t.position)==M.Castle&&i.push(L.BUY),!t.hasFlag(v.CantAttackAfterMoving)||!e){var s=this.getAttackTargets(t);s.length>0&&i.push(L.ATTACK)}if(t.hasFlag(v.CanRaise)){var n=this.getRaiseTargets(t);n.length>0&&i.push(L.RAISE)}return this.getAllianceAt(t.position)!=t.alliance&&(t.hasFlag(v.CanOccupyHouse)&&this.getTileAt(t.position)==M.House||t.hasFlag(v.CanOccupyCastle)&&this.getTileAt(t.position)==M.Castle)&&i.push(L.OCCUPY),e?i.push(L.END_MOVE):i.push(L.MOVE),i},t.prototype.getAttackTargets=function(t,e){for(var i=[],s=0,n=this.entities;s<n.length;s++){var o=n[s];if(o.alliance!=t.alliance&&!o.isDead()){var a=t.getDistanceToEntity(o);"undefined"!=typeof e&&(a=e.distanceTo(o.position)),a>t.data.max||a<t.data.min||i.push(o)}}return i},t.prototype.getRaiseTargets=function(t,e){for(var i=[],s=0,n=this.entities;s<n.length;s++){var o=n[s];if(o.isDead()){var a=t.getDistanceToEntity(o);"undefined"!=typeof e&&(a=e.distanceTo(o.position)),1==a&&i.push(o)}}return i},t.prototype.resetWisp=function(t){for(var e=0,i=this.entities;e<i.length;e++){var s=i[e];s.alliance==t&&(s.clearStatus(x.Wisped),this.hasWispInRange(s)&&s.setStatus(x.Wisped))}},t.prototype.hasWispInRange=function(t){for(var e=0,i=this.entities;e<i.length;e++){var s=i[e];if(s.alliance==t.alliance&&s.hasFlag(v.CanWisp)&&!s.isDead()){var n=t.getDistanceToEntity(s);if(!(1>n||n>2))return!0}}return!1},t.prototype.showRange=function(t,e){var i=null;return t!=A.Attack&&t!=A.Raise||(t==A.Attack?i=this.getAttackTargets(e):t==A.Raise&&(i=this.getRaiseTargets(e))),this.entity_range.createRange(t,e,i),this.entity_range},t.prototype.moveEntity=function(t,e,i,s){if(void 0===s&&(s=!0),!s)return t.position=e,t.setWorldPosition(e.getWorldPosition()),!0;if(this.getEntityAt(e)&&!e.match(t.position))return!1;var n=this.entity_range.getWaypointAt(e);if(!n)return!1;var o=R.getLineToWaypoint(n);return t.move(e,o,i),!0},t.prototype.nextTargetInRange=function(t){return this.entity_range.nextTargetInRange(t)},t.prototype.selectTargetInRange=function(t){return this.entity_range.selectTarget(t)},t.prototype.getTypeOfRange=function(){return this.entity_range.type},t}();!function(t){t[t.None=0]="None",t[t.Blue=1]="Blue",t[t.Red=2]="Red"}(N||(N={}));var L,D=function(){function t(t,e,i){this.waterState=0,this.waterTimer=0,this.map=t,this.tilemap=e,this.group=i,this.tilemap.addTilesetImage("tiles0",null,q.TILE_SIZE,q.TILE_SIZE,null,null,0),this.tilemap.addTilesetImage("buildings_0",null,q.TILE_SIZE,q.TILE_SIZE,null,null,q.NUMBER_OF_TILES),this.tilemap.addTilesetImage("buildings_1",null,q.TILE_SIZE,q.TILE_SIZE,null,null,q.NUMBER_OF_TILES+3),this.tilemap.addTilesetImage("buildings_2",null,q.TILE_SIZE,q.TILE_SIZE,null,null,q.NUMBER_OF_TILES+6),this.backgroundLayer=this.tilemap.create("background",this.map.width,this.map.height,q.TILE_SIZE,q.TILE_SIZE,this.group),this.backgroundLayer.resizeWorld(),this.buildingLayer=this.tilemap.createBlankLayer("building",this.map.width,this.map.height,q.TILE_SIZE,q.TILE_SIZE,this.group)}return t.doesTileCutGrass=function(t){return t==M.Path||t==M.Water||t==M.Bridge},t.getImageIndexForObjectTile=function(t){return t==M.Mountain?0:t==M.Forest?1:t==M.Hill?2:t==M.House?q.NUMBER_OF_TILES:t==M.Castle?q.NUMBER_OF_TILES+1:-1},t.getBaseImageIndexForTile=function(e){switch(e){case M.Water:return 21;case M.Bridge:return 19;case M.Path:return 18;case M.Hill:case M.Forest:case M.Mountain:case M.House:case M.Castle:return t.getImageIndexForObjectTile(e)}return 3},t.prototype.draw=function(){for(var t=0;t<this.map.width;t++)for(var e=0;e<this.map.height;e++)this.drawTileAt(new r(t,e))},t.prototype.update=function(t){this.waterTimer+=t,this.waterTimer>30&&(this.waterTimer=0,this.updateWater())},t.prototype.updateWater=function(){var t=this.waterState;this.waterState=1-this.waterState,this.tilemap.replace(21+t,21+this.waterState,0,0,this.map.width,this.map.height,this.backgroundLayer)},t.prototype.drawTileAt=function(e){this.tilemap.putTile(this.getImageIndexForBackgroundAt(e),e.x,e.y,this.backgroundLayer);var i=this.map.getTileAt(e),s=t.getImageIndexForObjectTile(i);if(s>=0){if(i==M.House||i==M.Castle){var n=this.map.getAllianceAt(e);s+=3*n,i==M.Castle&&e.y>0&&this.tilemap.putTile(s+1,e.x,e.y-1,this.buildingLayer)}this.tilemap.putTile(s,e.x,e.y,this.buildingLayer)}},t.prototype.getImageIndexForBackgroundAt=function(t){switch(this.map.getTileAt(t)){case M.Water:return 21;case M.Bridge:var e=this.map.getAdjacentTilesAt(t);return e[0]!=M.Water||e[2]!=M.Water?20:19;case M.Path:return 18;case M.Grass:case M.Hill:case M.Forest:case M.Mountain:case M.House:case M.Castle:return this.getImageIndexForGrassAt(t)}return 2},t.prototype.getImageIndexForGrassAt=function(e){for(var i=this.map.getAdjacentTilesAt(e),s=0,n=0;n<i.length;n++)s+=Math.pow(2,n)*(t.doesTileCutGrass(i[n])?1:0);return 15==s?3:13==s?16:14==s?10:7==s?17:11==s?14:9==s?12:12==s?8:6==s?9:3==s?13:5==s?15:10==s?6:8==s?4:4==s?7:2==s?5:1==s?11:3},t}(),C=function(){function t(t,e,i,s,n,o){
this.map=t,this.entity_group=e,this.selection_group=i,this.interaction_group=s,this.anim_group=n,this.delegate=o,this.selection_graphics=i.game.add.graphics(0,0,i),this.interaction_graphics=s.game.add.graphics(0,0,s),this.anim_idle_state=0,this.map.entity_range.init(this.interaction_group);for(var a=0,r=this.map.entities;a<r.length;a++){var h=r[a];this.createEntity(h)}}return t.prototype.selectEntity=function(t){this.entity_group.remove(t.sprite),this.entity_group.remove(t.icon_health),this.interaction_group.add(t.sprite),this.interaction_group.add(t.icon_health)},t.prototype.deselectEntity=function(t){this.interaction_group.remove(t.sprite),this.interaction_group.remove(t.icon_health),this.entity_group.addAt(t.icon_health,0),this.entity_group.addAt(t.sprite,0)},t.prototype.showRange=function(){this.show_range=!0,this.map.entity_range.draw(this.selection_graphics)},t.prototype.hideRange=function(){this.show_range=!1,this.map.entity_range.clear(this.selection_graphics,this.interaction_graphics)},t.prototype.update=function(t,e,i){for(var s=0,n=this.map.entities;s<n.length;s++){var o=n[s];this.anim_idle_state!=i&&o.setFrame(this.anim_idle_state),o.update(t)}this.anim_idle_state=i,this.show_range&&this.map.entity_range.update(t,e,i,this.selection_graphics,this.interaction_graphics)},t.prototype.animationDidEnd=function(t){switch(t.entity.animation=null,t.type){case y.Attack:var e=t;if(e.first&&e.entity.shouldCounter(e.attacker.position))return void this.attackEntity(e.entity,e.attacker,!1);var i=e.first?e.attacker:e.entity,s=e.first?e.entity:e.attacker;i.hasFlag(v.CanPoison)&&(s.setStatus(x.Poisoned),s.status_animation=0),i.shouldRankUp()&&(i.status_animation=2),s.shouldRankUp()&&(s.status_animation=2),(i.isDead()||i.status_animation>=0)&&i.startAnimation(new S(i,this,this.anim_group,i.isDead()?-1:i.status_animation)),(s.isDead()||s.status_animation>=0)&&s.startAnimation(new S(s,this,this.anim_group,s.isDead()?-1:s.status_animation)),this.delegate.entityDidAnimation(e.entity);break;case y.Status:t.entity.status_animation=-1;break;case y.Raise:this.delegate.entityDidAnimation(t.entity)}},t.prototype.showWisped=function(){for(var t=0,e=this.map.entities;t<e.length;t++){var i=e[t];i.status==x.Wisped&&(i.animation||i.startAnimation(new S(i,this,this.anim_group,1)))}},t.prototype.attackEntity=function(t,e,i){void 0===i&&(i=!0),t.attack(e,this.map),e.startAnimation(new E(e,this,this.anim_group,t,i))},t.prototype.raiseEntity=function(t,e){e.startAnimation(new T(e,this,this.anim_group,t.alliance))},t.prototype.createEntity=function(t){t.init(this.entity_group)},t}(),s=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},O=function(t){function e(e,i,s,n){t.call(this),this.position=e,t.prototype.init.call(this,new r(e.x*q.TILE_SIZE+16,e.y*q.TILE_SIZE),i,s,n)}return s(e,t),e}(p),U=function(){function t(t,e){this.map=t,this.group=e,this.anim_slow=0,this.anim_state=0,this.anim_offset=0,this.smoke=[];for(var i=0,s=t.getOccupiedHouses();i<s.length;i++){var n=s[i];this.createSmoke(n.position)}this.createSmoke(new r(3,13))}return t.prototype.createSmoke=function(t){this.smoke.push(new O(t,this.group,"b_smoke",[0,1,2,3]))},t.prototype.update=function(t){if(this.anim_slow+=t,!(this.anim_slow<5)){this.anim_slow=0,this.anim_offset++,this.anim_offset>27?(this.anim_state=0,this.anim_offset=0,this.group.visible=!0):this.anim_offset>22&&3==this.anim_state?(this.anim_state=4,this.group.visible=!1):this.anim_offset>17&&2==this.anim_state?this.anim_state=3:this.anim_offset>12&&1==this.anim_state?this.anim_state=2:this.anim_offset>7&&0==this.anim_state&&(this.anim_state=1);for(var e=0,i=this.smoke;e<i.length;e++){var s=i[e];s.setFrame(this.anim_state),s.world_position.y=s.position.y*q.TILE_SIZE-this.anim_offset-2,s.update()}}},t}(),F=function(){function t(t){this.group=t,this.frames=[]}return t.prototype.addFrame=function(t){t.delegate=this,this.frames.push(t)},t.prototype.removeFrame=function(t){for(var e=0;e<this.frames.length;e++)if(t==this.frames[e]){this.frames.splice(e,1);break}},t.prototype.update=function(t){for(var e=0,i=this.frames;e<i.length;e++){var s=i[e];s.update(t)}},t.prototype.frameWillDestroy=function(t){this.removeFrame(t)},t}(),s=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},W=function(e){function n(t){e.call(this),this.initialize(64,40,t,o.Up|o.Right,o.Down|o.Left,o.Right),this.drawContent()}return s(n,e),n.prototype.updateContent=function(t,e){var i,s,n;t==N.Blue?(i=255,s=0,n=0):(i=16711680,s=1,n=25),this.head_graphics.clear(),this.head_graphics.beginFill(i),this.head_graphics.drawRect(0,17,this.width-6,17),this.head_graphics.endFill(),this.head_icon.frame=s,this.head_icon.x=n,this.gold_amount.setText(e.toString())},n.prototype.drawContent=function(){this.head_graphics=this.group.game.add.graphics(0,0,this.content_group),this.group.game.add.image(2,2,"gold",null,this.content_group),this.head_icon=this.group.game.add.image(0,16,"portrait",0,this.content_group);var e=new Phaser.Rectangle(0,10,this.head_icon.width,18);this.head_icon.crop(e),this.gold_amount=new i(28,5,this.content_group,t.Bold)},n}(f),G=function(e){function n(t){e.call(this),this.initialize(40,52,t,o.Down|o.Right,o.Up|o.Left,o.Right),this.drawContent()}return s(n,e),n.prototype.updateContent=function(t,e){var i=e.getTileAt(t),s=e.getEntityAt(t);if(i==M.House||i==M.Castle){var n=e.getAllianceAt(t);this.tile_icon.key!="buildings_"+n&&this.tile_icon.loadTexture("buildings_"+n),this.tile_icon.frame=i==M.House?0:1}else"tiles0"!=this.tile_icon.key&&this.tile_icon.loadTexture("tiles0"),this.tile_icon.frame=D.getBaseImageIndexForTile(i);this.def_amount.setText(P.getDefForTile(i,s?s.type:void 0).toString()),s&&!s.isDead()?(this.updateSize(68,52),this.entity_icon.key!="unit_icons_"+s.alliance&&this.entity_icon.loadTexture("unit_icons_"+s.alliance),this.entity_icon.frame=s.type,this.entity_icon.visible=!0):(this.updateSize(40,52),this.entity_icon.visible=!1),this.setStatusIcons(s)},n.prototype.drawContent=function(){var e=this.group.game.add.graphics(0,0,this.content_group);e.lineStyle(1,0),e.drawRect(6,2,q.TILE_SIZE-1,q.TILE_SIZE-1),this.tile_icon=this.group.game.add.image(7,3,"tiles0",null,this.content_group);var s=new Phaser.Rectangle(1,1,q.TILE_SIZE-2,q.TILE_SIZE-2);this.tile_icon.crop(s);var n=new i(7,28,this.content_group,t.Bold);n.setText("DEF"),this.def_amount=new i(14,37,this.content_group,t.Bold),this.entity_icon=this.group.game.add.image(35,2,"unit_icons_1",null,this.content_group),this.entity_icon.visible=!1,this.status_icons=[this.group.game.add.image(31,22,"status",2,this.content_group),this.group.game.add.image(39,22,"status",2,this.content_group),this.group.game.add.image(47,22,"status",2,this.content_group),this.group.game.add.image(31,32,"status",0,this.content_group),this.group.game.add.image(46,32,"status",1,this.content_group)],this.setStatusIcons(null)},n.prototype.setStatusIcons=function(t){this.status_icons[0].visible=!!(t&&t.rank>0),this.status_icons[1].visible=!!(t&&t.rank>1),this.status_icons[2].visible=!!(t&&t.rank>2),this.status_icons[3].visible=!(!t||t.status==x.None),this.status_icons[3].frame=t&&0!=(t.status&x.Poisoned)?0:1,this.status_icons[4].visible=!(!t||t.status!=(x.Wisped|x.Poisoned))},n}(f);!function(t){t[t.None=0]="None",t[t.MAIN_MENU=1]="MAIN_MENU",t[t.MOVE=2]="MOVE",t[t.ATTACK=3]="ATTACK",t[t.BUY=4]="BUY",t[t.END_MOVE=5]="END_MOVE",t[t.CANCEL=6]="CANCEL",t[t.END_TURN=7]="END_TURN",t[t.OCCUPY=8]="OCCUPY",t[t.RAISE=9]="RAISE",t[t.MAP=10]="MAP",t[t.OBJECTIVE=11]="OBJECTIVE",t[t.NEW_GAME=12]="NEW_GAME",t[t.SELECT_LEVEL=13]="SELECT_LEVEL",t[t.SAVE_GAME=14]="SAVE_GAME",t[t.LOAD_GAME=15]="LOAD_GAME",t[t.SKIRMISH=16]="SKIRMISH",t[t.SETTINGS=17]="SETTINGS",t[t.INSTRUCTIONS=18]="INSTRUCTIONS",t[t.ABOUT=19]="ABOUT",t[t.EXIT=20]="EXIT"}(L||(L={}));var B,K=function(t){function e(i,s,n,a,r){t.call(this),r||(r=s),this.menu_delegate=a,this.options=n,this.selected=0;for(var h=0,p=0,c=this.options;p<c.length;p++){var l=c[p],u=e.getOptionString(l);u.length>h&&(h=u.length)}var g=13*this.options.length+16,d=7*h+31+13;this.initialize(d,g,i,s,o.All&~s,r),this.drawContent()}return s(e,t),e.getMainMenuOptions=function(t){var e;return e=t?[L.SAVE_GAME,L.LOAD_GAME,L.INSTRUCTIONS,L.ABOUT,L.EXIT]:[L.NEW_GAME,L.LOAD_GAME,L.SKIRMISH,L.INSTRUCTIONS,L.ABOUT,L.EXIT]},e.getOffMenuOptions=function(){return[L.END_TURN,L.MAP,L.OBJECTIVE,L.MAIN_MENU]},e.getOptionString=function(t){return t==L.None?"":t>=12?q.LANG[t-12+1]:q.LANG[26+t]},e.prototype.drawContent=function(){var t=5;this.fonts=[];for(var i=0,s=this.options;i<s.length;i++){var n=s[i],o=e.getOptionString(n),a=this.group.game.add.bitmapText(25,t,"font7",o,7,this.content_group);this.fonts.push(a),t+=13}this.pointer=this.group.game.add.image(4,4,"pointer",null,this.content_group),this.pointer_state=2,this.pointer_slow=0},e.prototype.hide=function(e,i,s){void 0===e&&(e=!1),void 0===i&&(i=!1),void 0===s&&(s=!1),this.menu_delegate&&this.menu_delegate.closeMenu(B.Options),t.prototype.hide.call(this,e,i,s)},e.prototype.show=function(e,i){void 0===e&&(e=!1),void 0===i&&(i=0),this.menu_delegate&&this.menu_delegate.openMenu(B.Options),t.prototype.show.call(this,e,i)},e.prototype.next=function(){this.selected++,this.selected>=this.options.length&&(this.selected=0)},e.prototype.prev=function(){this.selected--,this.selected<0&&(this.selected=this.options.length-1)},e.prototype.getSelected=function(){return this.options[this.selected]},e.prototype.update=function(e){t.prototype.update.call(this,e),this.pointer_slow++,this.pointer_slow>10&&(this.pointer_slow=0,this.pointer_state=2-this.pointer_state),this.pointer.y=4+13*this.selected,this.pointer.x=4+this.pointer_state},e}(f),H=function(t){function e(e,i,s,n,a){t.call(this),this.menu_delegate=s,this.options=e,this.selected=0;for(var r=0,h=0,p=this.options;h<p.length;h++){var c=p[h];c.length>r&&(r=c.length)}var l=13*this.options.length+16,u=7*r+31+13;this.initialize(u,l,i,n,o.All&~n,a),this.drawContent()}return s(e,t),e.prototype.drawContent=function(){var t=5;this.fonts=[];for(var e=0,i=this.options;e<i.length;e++){var s=i[e],n=this.group.game.add.bitmapText(25,t,"font7",s,7,this.content_group);this.fonts.push(n),t+=13}this.pointer=this.group.game.add.image(4,4,"pointer",null,this.content_group),this.pointer_state=2,this.pointer_slow=0},e.prototype.hide=function(e,i,s){void 0===e&&(e=!1),void 0===i&&(i=!1),void 0===s&&(s=!1),this.menu_delegate&&this.menu_delegate.closeMenu(B.Options),t.prototype.hide.call(this,e,i,s)},e.prototype.show=function(e,i){void 0===e&&(e=!1),void 0===i&&(i=0),this.menu_delegate&&this.menu_delegate.openMenu(B.Options),t.prototype.show.call(this,e,i)},e.prototype.next=function(){this.selected++,this.selected>=this.options.length&&(this.selected=0)},e.prototype.prev=function(){this.selected--,this.selected<0&&(this.selected=this.options.length-1)},e.prototype.getSelected=function(){return this.options[this.selected]},e.prototype.update=function(e){t.prototype.update.call(this,e),this.pointer_slow++,this.pointer_slow>10&&(this.pointer_slow=0,this.pointer_state=2-this.pointer_state),this.pointer.y=4+13*this.selected,this.pointer.x=4+this.pointer_state},e}(f),Z=function(t){function e(e,i,s){t.call(this),this.menu_delegate=s,this.font=e.game.add.bitmapText(9,5,"font7",i,7),this.font.updateTransform();var n=this.font.textWidth+30;this.initialize(n,29,e,o.None,o.All,o.None),this.content_group.add(this.font)}return s(e,t),e.prototype.show=function(e){void 0===e&&(e=!1),this.menu_delegate&&this.menu_delegate.openMenu(B.Wait),t.prototype.show.call(this,e)},e.prototype.animationDidEnd=function(t){var e=this;0!=(t&g.Show)?setTimeout(function(){e.hide(!0,!0)},1e3):0!=(t&g.Destroy)&&this.menu_delegate&&this.menu_delegate.closeMenu(B.Wait)},e}(f),V=function(t){function e(e,i){t.call(this),this.selected=0,this.menu_delegate=i,this.initialize(64,e.game.height-40,e,o.Right|o.Down,o.Up|o.Down|o.Left,o.Right),this.drawContent()}return s(e,t),e.prototype.updateContent=function(t,e){for(var i=0,s=0,n=this.entity_images;s<n.length;s++){var o=n[s],a=q.ENTITIES[i].cost;o.loadTexture("unit_icons_"+t,o.frame),this.masks[i].visible=a>e,i++}},e.prototype.getSelected=function(){return this.selected},e.prototype.show=function(e){void 0===e&&(e=!1),this.menu_delegate&&this.menu_delegate.openMenu(B.Shop),t.prototype.show.call(this,e)},e.prototype.hide=function(e,i,s){void 0===e&&(e=!1),void 0===i&&(i=!1),void 0===s&&(s=!1),this.menu_delegate&&this.menu_delegate.closeMenu(B.Shop),t.prototype.hide.call(this,e,i,s)},e.prototype.update=function(e){t.prototype.update.call(this,e),this.pointer_slow++,this.pointer_slow>10&&(this.pointer_slow=0,this.pointer_state=2-this.pointer_state),this.pointer.y=5+29*Math.floor(this.selected/2),this.pointer.x=-9+this.selected%2*28+this.pointer_state},e.prototype.prev=function(t){t?this.selected-=2:this.selected--,this.selected<0&&(this.selected+=this.entity_images.length)},e.prototype.next=function(t){t?this.selected+=2:this.selected++,this.selected>=this.entity_images.length&&(this.selected-=this.entity_images.length)},e.prototype.drawContent=function(){this.entity_images=[],this.masks=[];for(var t=0;t<q.ENTITIES.length;t++){var e=q.ENTITIES[t];if(!(e.cost>1e3)){var i=t%2*27+3,s=29*Math.floor(t/2)+5,n=this.group.game.add.image(i,s,"unit_icons_1",t,this.content_group);this.entity_images.push(n);var o=this.group.game.add.image(i,s,"mask",0,this.content_group);this.masks.push(o)}}this.pointer=this.group.game.add.image(4,4,"pointer",null,this.content_group),this.pointer_state=2,this.pointer_slow=0},e}(f),z=function(e){function n(t,i){e.call(this),this.initialize(t.game.width-64,t.game.height,t,o.Left,o.Up|o.Right|o.Down,o.Left),this.drawContent(i)}return s(n,e),n.prototype.updateContent=function(t){var e=q.ENTITIES[t];this.unit_icon.frame=t,this.unit_name.setText(e.name.toUpperCase()),this.unit_cost.setText(e.cost.toString()),this.unit_atk.setText(e.atk.toString()),this.unit_def.setText(e.def.toString()),this.unit_mov.setText(e.mov.toString()),this.unit_text.setText(q.LANG[75+t])},n.prototype.drawContent=function(e){this.unit_icon=this.group.game.add.image(2,2,"unit_icons_"+(e==N.Blue?1:2),0,this.content_group),this.unit_name=this.group.game.add.bitmapText(29,4,"font7","",7,this.content_group),this.group.game.add.image(28,13,"gold",0,this.content_group),this.unit_cost=new i(54,16,this.content_group,t.Bold,""),new i(2,33,this.content_group,t.Bold,"ATK"),this.unit_atk=new i(95,33,this.content_group,t.Bold,""),new i(2,43,this.content_group,t.Bold,"DEF"),this.unit_def=new i(95,43,this.content_group,t.Bold,""),new i(2,53,this.content_group,t.Bold,"MOV"),this.unit_mov=new i(95,53,this.content_group,t.Bold,""),this.unit_text=this.group.game.add.bitmapText(6,69,"font7","",7,this.content_group),this.unit_text.maxWidth=this.group.game.width-64-18},n}(f),s=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)};!function(t){t[t.Wait=0]="Wait",t[t.Shop=1]="Shop",t[t.Options=2]="Options",t[t.Map=3]="Map",t[t.Selection=4]="Selection",t[t.Animation=5]="Animation",t[t.Ack=6]="Ack",t[t.Instructions=7]="Instructions"}(B||(B={}));var j,Y=function(t){function e(){t.call(this),this.acc=0}return s(e,t),e.prototype.init=function(t){this.map=new P((t.campaign?"m":"s")+t.map),this.players=[],this.game_over=!1;for(var e,i=N.Blue,s=0,n=t.players;s<n.length;s++){var o=n[s];o?(e||(e=new d(this.game.input)),this.players.push(new m(i,this.map,this,e))):this.players.push(new a(i,this.map,this)),i+=1}try{this.turn=t.turn,this.gold=t.gold,this.map.importBuildings(t.buildings),this.map.importEntities(t.entities);for(var h=0,p=0,c=t.cursors;p<c.length;p++){var l=c[p];l&&(this.players[h].cursor_position=new r(l.x,l.y)),h++}}catch(u){this.turn=N.Blue,this.gold=[],t.campaign?(this.gold[0]=300,this.gold[1]=300):(this.gold[0]=1e3,this.gold[1]=1e3)}},e.prototype.create=function(){var t=this.game.add.tilemap(),e=this.game.add.group(),i=this.game.add.group(),s=this.game.add.group(),n=this.game.add.group(),o=this.game.add.group(),a=this.game.add.group(),r=this.game.add.group(),h=this.game.add.group();h.fixedToCamera=!0,this.tile_manager=new D(this.map,t,e),this.entity_manager=new C(this.map,n,s,o,r,this),this.smoke_manager=new U(this.map,i),this.frame_manager=new F(h),this.tile_manager.draw(),this.frame_def_info=new G(h),this.frame_manager.addFrame(this.frame_def_info),this.frame_def_info.show(!0),this.frame_gold_info=new W(h),this.frame_manager.addFrame(this.frame_gold_info),this.frame_gold_info.show(!0),this.cursor=new p,this.cursor.init({x:0,y:0},a,"cursor",[0,1]),this.cursor.setOffset(-1,-1),this.camera.x=this.getOffsetX(this.cursor.world_position.x),this.camera.y=this.getOffsetY(this.cursor.world_position.y),this.anim_cursor_state=0,this.anim_cursor_slow=0,this.startTurn(this.turn),this.showMessage("GAME LOADED")},e.prototype.update=function(){this.acc+=this.time.elapsed;var t=Math.floor(this.acc/16);if(!(0>=t)){this.acc-=16*t,t>2&&(t=2);var e=this.cursor_target.getWorldPosition(),i=e.x-this.cursor.world_position.x,s=e.y-this.cursor.world_position.y,n=0,a=0;this.cursor_still=0==i&&0==s,0!=i&&(n=Math.floor(i/4),0>n?(n=Math.max(n,-4),n=Math.min(n,-1)):(n=Math.min(n,4),n=Math.max(n,1)),this.cursor.setWorldPosition({x:this.cursor.world_position.x+n,y:this.cursor.world_position.y+a})),0!=s&&(a=Math.floor(s/4),0>a?(a=Math.max(a,-4),a=Math.min(a,-1)):(a=Math.min(a,4),a=Math.max(a,1)),this.cursor.setWorldPosition({x:this.cursor.world_position.x+n,y:this.cursor.world_position.y+a})),this.updateOffsetForPosition(this.selected_entity&&this.selected_entity.path?this.selected_entity.world_position:this.cursor.world_position),this.checkWinLose(),this.game_over||(this.players[this.turn-1].run(),this.players[this.turn-1].setCursorPosition(this.cursor_target)),this.cursor_target.match(this.last_cursor_position)||(this.last_cursor_position=this.cursor_target.copy(),this.frame_def_info.updateContent(this.cursor_target,this.map)),this.frame_manager.update(t),this.anim_cursor_slow+=t,this.anim_cursor_slow>30&&(this.anim_cursor_slow-=30,this.anim_cursor_state=1-this.anim_cursor_state,this.cursor.setFrame(this.anim_cursor_state)),this.tile_manager.update(t),this.smoke_manager.update(t),this.entity_manager.update(t,this.cursor_target,this.anim_cursor_state);var r=0!=(this.frame_gold_info.align&o.Right);!r&&this.cursor.world_position.x-1-this.camera.x<=this.game.width/2-24-12?(this.frame_gold_info.updateDirections(o.Up|o.Right,o.Left|o.Down,o.Right,!0),this.frame_def_info.updateDirections(o.Down|o.Right,o.Left|o.Up,o.Right,!0)):r&&this.cursor.world_position.x+1-this.camera.x>=this.game.width/2+12&&(this.frame_gold_info.updateDirections(o.Up|o.Left,o.Right|o.Down,o.Left,!0),this.frame_def_info.updateDirections(o.Down|o.Left,o.Right|o.Up,o.Left,!0))}},e.prototype.openMenu=function(t){this.players[this.turn-1].openMenu(t)},e.prototype.closeMenu=function(t){for(var e=0,i=this.players;e<i.length;e++){var s=i[e];s.closeMenu(t)}},e.prototype.entityDidMove=function(t){this.players[this.turn-1].entityDidMove(t)},e.prototype.entityDidAnimation=function(t){this.players[this.turn-1].entityDidAnimation(t)},e.prototype.showMessage=function(t){var e=new Z(this.frame_manager.group,t,this);this.frame_manager.addFrame(e),e.show(!0)},e.prototype.showInfo=function(t){this.frame_def_info.show(!0),t&&this.frame_gold_info.show(!0)},e.prototype.hideInfo=function(t){this.frame_def_info.hide(!0),t&&this.frame_gold_info.hide(!0)},e.prototype.loadGame=function(){return J.loadGame(this.game)?!0:(this.showMessage(q.LANG[43]),!1)},e.prototype.saveGame=function(){for(var t=[],e=[],i=0,s=this.players;i<s.length;i++){var n=s[i];t.push(n.getCursorPosition()),e.push(n.isPlayer())}var o={campaign:this.map.isCampaign(),map:this.map.getMap(),turn:this.turn,gold:this.gold,players:e,entities:this.map.exportEntities(),buildings:this.map.exportBuildings(),cursors:t};localStorage.setItem("save.rs",JSON.stringify(o)),this.showMessage(q.LANG[41])},e.prototype.exitGame=function(){this.game.state.start("MainMenu",!0,!1)},e.prototype.checkWinLose=function(){this.game_over||(this.map.countEntitiesWith(N.Blue,I.Dead,k.King)>0?(this.showMessage(q.LANG[38]),this.game_over=!0):this.map.countEntitiesWith(N.Red,I.Dead,k.King)>0&&(this.showMessage(q.LANG[24]),this.game_over=!0))},e.prototype.nextTurn=function(){this.showMessage(q.LANG[40]);var t=N.Blue;this.turn==N.Blue&&(t=N.Red),this.players[t-1].isActive()||(t=this.turn),this.gold[t==N.Blue?0:1]+=this.map.getGoldGainForAlliance(t),this.map.nextTurn(t),this.startTurn(t)},e.prototype.getGoldForAlliance=function(t){switch(t){case N.Blue:return this.gold[0];case N.Red:return this.gold[1]}return-1},e.prototype.setGoldForAlliance=function(t,e){var i;switch(t){case N.Blue:i=0;break;case N.Red:i=1}this.gold[i]=e,this.turn==t&&this.frame_gold_info.updateContent(t,e)},e.prototype.buyEntity=function(t,e){var i=q.ENTITIES[e],s=this.getGoldForAlliance(t.alliance)-i.cost;if(0>s)return null;this.setGoldForAlliance(t.alliance,s);var n=this.map.createEntity(e,t.alliance,t.position.copy());return this.entity_manager.createEntity(n),n},e.prototype.selectEntity=function(t){return this.selected_entity?!1:(this.selected_entity=t,this.entity_manager.selectEntity(t),!0)},e.prototype.moveEntity=function(t,e,i){return this.map.moveEntity(t,e,this,i)?(this.hideRange(),!0):!1},e.prototype.occupy=function(t,e){this.map.setAllianceAt(t,e),this.tile_manager.drawTileAt(t),this.showMessage(q.LANG[39])},e.prototype.showRange=function(t,e){return this.map.showRange(t,e),this.entity_manager.showRange(),this.map.entity_range},e.prototype.hideRange=function(){this.entity_manager.hideRange()},e.prototype.attackEntity=function(t,e){this.entity_manager.attackEntity(t,e)},e.prototype.raiseEntity=function(t,e){this.entity_manager.raiseEntity(t,e)},e.prototype.deselectEntity=function(t){this.selected_entity&&(this.cursor_target=this.selected_entity.position.copy(),this.hideRange(),this.entity_manager.deselectEntity(this.selected_entity),this.selected_entity=null,t&&(this.map.resetWisp(this.turn),this.entity_manager.showWisped(),this.frame_def_info.updateContent(this.cursor_target,this.map)))},e.prototype.startTurn=function(t){this.turn=t;var e=this.players[t-1];e.start(),this.cursor_target=e.getCursorPosition();var i=this.cursor_target.getWorldPosition();this.cursor.setWorldPosition(i),this.frame_gold_info.updateContent(t,this.getGoldForAlliance(t))},e.prototype.updateOffsetForPosition=function(t){var e=t.x+.5*q.TILE_SIZE,i=t.y+.5*q.TILE_SIZE;this.updateOffset(e,i)},e.prototype.updateOffset=function(t,e){var i=this.getOffsetX(t),s=this.getOffsetY(e),n=i-this.camera.x,o=s-this.camera.y;if(this.camera_still=0==n&&0==o,0!=n){var a=Math.floor(n/12);0>a?(a=Math.max(a,-4),a=Math.min(a,-1)):(a=Math.min(a,4),a=Math.max(a,1)),this.camera.x+=a}if(0!=o){var r=Math.floor(o/12);0>r?(r=Math.max(r,-4),r=Math.min(r,-1)):(r=Math.min(r,4),r=Math.max(r,1)),this.camera.y+=r}},e.prototype.getOffsetX=function(t){var e=t-this.game.width/2;return this.game.width<this.world.width?(e=Math.max(e,0),e=Math.min(e,this.world.width-this.game.width)):e=(this.game.width-this.world.width)/2,e},e.prototype.getOffsetY=function(t){var e=t-this.game.height/2;return this.game.height<this.world.height?(e=Math.max(e,0),e=Math.min(e,this.world.height-this.game.height)):e=(this.game.height-this.world.height)/2,e},e}(Phaser.State),s=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)};!function(t){t[t.CampaignMaps=0]="CampaignMaps",t[t.SkirmishMaps=1]="SkirmishMaps",t[t.SkirmishPlayers=2]="SkirmishPlayers"}(j||(j={}));var X,J=function(t){function e(){t.call(this)}return s(e,t),e.drawTransition=function(t,e,i,s,n){for(var o=Math.ceil(s/4),a=Math.ceil(n/2),r=e-6,h=0;4>h;h++){var p=Math.floor(t-2*h);if(0>=p)break;var c=void 0,l=void 0;p>=r?(c=o,l=a):(c=Math.floor(p*o/r),l=Math.floor(p*a/r));for(var u=Math.floor((o-c)/2),g=Math.floor((a-l)/2),d=h*o+u,y=0;2>y;y++){var f=y*a+g;i.drawRect(d,f,c,l)}}},e.loadGame=function(t){var e;try{var i=localStorage.getItem("save.rs");e=JSON.parse(i)}catch(s){return!1}return e?(t.state.start("Game",!0,!1,e),!0):!1},e.startGame=function(t,e,i,s){void 0===s&&(s=[!0,!1]);var n={campaign:e,map:i,players:s};t.state.start("Game",!0,!1,n)},e.showAbout=function(t){var e=t.add.group();e.fixedToCamera=!0;var i=t.add.graphics(0,0,e);i.beginFill(16777215),i.drawRect(0,0,t.width,t.height),i.endFill(),i.beginFill(0),i.drawRect(0,37,t.width,1),i.endFill(),t.add.bitmapText(10,26,"font7",q.LANG[8],7,e);var s=t.add.bitmapText(10,42,"font7",q.LANG[0]+q.LANG[14],7,e);return s.maxWidth=t.width-20,e},e.showInstructions=function(t,e){void 0===e&&(e=0),t.removeChildren();var i=t.game.add.graphics(0,0,t);i.beginFill(16777215),i.drawRect(0,0,t.game.width,t.game.height),i.endFill(),i.beginFill(0),i.drawRect(0,37,t.game.width,1),i.endFill(),t.game.add.bitmapText(10,26,"font7",q.LANG[7]+(e>0?" - "+e:""),7,t);var s=t.game.add.bitmapText(10,42,"font7",q.LANG[e>0?86+e:13],7,t);s.maxWidth=t.game.width-20},e.prototype.openMenu=function(t){t==B.Wait&&(this.notification_shown=!0)},e.prototype.closeMenu=function(t){t==B.Wait&&(this.notification_shown=!1)},e.prototype.create=function(){this.notification_shown=!1,this.intro=!0,this.intro_acc=0,this.intro_progress=0,this.game.add.image(0,0,"splashbg"),this.knights=this.game.add.image(0,26,"splashfg"),this.title=this.game.add.image(0,8,"splash"),this.title.x=Math.floor((this.game.width-this.title.width)/2),this.title.visible=!1,this.title_mask=this.game.add.graphics(this.title.x,this.title.y),this.title.mask=this.title_mask;var t=this.game.add.group();this.frame_manager=new F(t),this.keys=new d(this.game.input)},e.prototype.update=function(){if(this.intro)this.intro_acc++,this.intro_acc<2||(this.intro_acc=0,this.intro_progress++,this.intro_progress<=30?this.knights.y=26-this.intro_progress:this.intro_progress<=60?(this.title.visible=!0,this.title_mask.clear(),this.title_mask.beginFill(),e.drawTransition(Math.ceil((this.intro_progress-30)/2),15,this.title_mask,this.title.width,this.title.height),this.title_mask.endFill()):(this.title_mask.clear(),this.main=new K(this.frame_manager.group,o.None,K.getMainMenuOptions(!1),this,o.Up),this.frame_manager.addFrame(this.main),this.main.show(!0,72),this.intro=!1));else{if(this.keys.update(),this.frame_manager.update(1),this.notification_shown)return;if(this.keys.isKeyPressed(h.Up))this.keys.clearKeyPressed(h.Up),this.menu_select?this.menu_select.prev():this.main.prev();else if(this.keys.isKeyPressed(h.Down))this.keys.clearKeyPressed(h.Down),this.menu_select?this.menu_select.next():this.main.next();else if(this.keys.isKeyPressed(h.Enter))if(this.keys.clearKeyPressed(h.Enter),this.active_about)this.active_about.destroy(!0),this.active_about=null;else if(this.active_instructions){var t=this.active_instruction_nr+1;17>=t&&(this.active_instruction_nr=t,e.showInstructions(this.active_instructions,this.active_instruction_nr))}else if(this.menu_select)this.selectChoice(this.menu_select.selected);else{var i=this.main.getSelected();this.executeAction(i)}else if(this.keys.isKeyPressed(h.Esc))this.active_about?(this.active_about.destroy(!0),this.active_about=null):this.active_instructions?(this.active_instructions.destroy(!0),this.active_instructions=null):this.menu_select&&(this.menu_select.hide(!1,!0),this.menu_select=null,this.main.show(!0,72));else if(this.keys.isKeyPressed(h.Right)){if(this.keys.clearKeyPressed(h.Right),this.active_instructions){var t=this.active_instruction_nr+1;17>=t&&(this.active_instruction_nr=t,e.showInstructions(this.active_instructions,this.active_instruction_nr))}}else if(this.keys.isKeyPressed(h.Left)&&(this.keys.clearKeyPressed(h.Left),this.active_instructions)){var s=this.active_instruction_nr-1;s>=0&&(this.active_instruction_nr=s,e.showInstructions(this.active_instructions,this.active_instruction_nr))}}},e.prototype.showMessage=function(t){var e=new Z(this.frame_manager.group,t,this);this.frame_manager.addFrame(e),e.show(!0)},e.prototype.executeAction=function(t){switch(t){case L.LOAD_GAME:e.loadGame(this.game)?this.main.hide(!1):this.showMessage(q.LANG[43]);break;case L.NEW_GAME:this.main.hide(!1),e.startGame(this.game,!1,0);break;case L.SELECT_LEVEL:for(var i=[],s=0;7>s;s++)i.push(q.LANG[49+s]);this.main.hide(!1),this.active_select=j.CampaignMaps,this.menu_select=new H(i,this.frame_manager.group,this,o.None,o.Up),this.frame_manager.addFrame(this.menu_select),this.menu_select.show(!0,72);break;case L.SKIRMISH:this.main.hide(!1),this.active_select=j.SkirmishMaps,this.menu_select=new H(["Island Cross","Rocky Bay"],this.frame_manager.group,this,o.None,o.Up),this.frame_manager.addFrame(this.menu_select),this.menu_select.show(!0,72);break;case L.ABOUT:this.active_about=e.showAbout(this.game);break;case L.INSTRUCTIONS:this.active_instructions=this.game.add.group(),this.active_instruction_nr=0,e.showInstructions(this.active_instructions)}},e.prototype.selectChoice=function(t){switch(this.menu_select.hide(!1,!0),this.menu_select=null,this.active_select){case j.CampaignMaps:e.startGame(this.game,!0,t);break;case j.SkirmishMaps:this.active_skirmish=t,this.active_select=j.SkirmishPlayers,this.menu_select=new H(["1 PLAYER","2 PLAYER","AI ONLY"],this.frame_manager.group,this,o.None,o.Up),this.frame_manager.addFrame(this.menu_select),this.menu_select.show(!0,72);break;case j.SkirmishPlayers:var i=[2!=t,1==t];e.startGame(this.game,!1,this.active_skirmish,i)}},e}(Phaser.State),q=function(){function t(e){this.width=176,this.height=204,t.game=new Phaser.Game(this.width,this.height,Phaser.AUTO,e,this,!1,!1),this.loader=new u,this.mainMenu=new J,this.controller=new Y,t.game.state.add("Loader",this.loader),t.game.state.add("MainMenu",this.mainMenu),t.game.state.add("Game",this.controller),t.game.state.start("Loader")}return t.TILE_SIZE=24,t.MINI_SIZE=10,t.LINE_SEGMENT_LENGTH=10,t.LINE_SEGMENT_WIDTH=4,t.LINE_SEGMENT_SPACING=2,t.DEATH_COUNT=3,t.NUMBER_OF_TILES=23,t}();!function(t){t[t.None=0]="None",t[t.Hide=1]="Hide",t[t.Show=2]="Show"}(X||(X={}));(function(){function t(t,e,i,s){this.background_graphics=t.add.graphics(0,0),this.background_graphics.fixedToCamera=!0,this.group=t.add.group(),this.group.fixedToCamera=!0,this.group.visible=!1,this.content_graphics=this.group.game.add.graphics(0,0,this.group),this.transition_mask=t.add.graphics(0,0),this.transition_mask.clear(),this.transition_mask.fixedToCamera=!0,this.group.mask=this.transition_mask,this.attacker=e,this.target=i,this.map=s,this.transition=X.None}return t.drawTransition=function(t,e,i,s,n){for(var o=Math.floor(s/4)+1,a=Math.floor(n/4)+1,r=e-6,h=0;4>h;h++){var p=Math.floor(t-2*h);if(0>=p)break;var c=void 0,l=void 0;p>=r?(c=o,l=a):(c=Math.floor(p*o/r),l=Math.floor(p*a/r));for(var u=Math.floor((o-c)/2),g=Math.floor((a-l)/2),d=h*o+u,y=0;4>y;y++){var f=y*a+g;i.drawRect(d,f,c,l)}}},t.getBackgroundPrefixForTile=function(t){switch(t){case M.Forest:return"woods";case M.Hill:return"hill";case M.Mountain:return"mountain";case M.Water:return"water";case M.Bridge:return"bridge";case M.House:case M.Castle:return"town"}return null},t.getNameForTile=function(t){switch(t){case M.Grass:case M.Hill:case M.Forest:return"grass";case M.Path:return"road";case M.Mountain:return"mountain";case M.Water:return"water";case M.Bridge:return"bridge";case M.House:case M.Castle:return"town"}return null},t.prototype.show=function(){this.transition_progress=0,this.transition=X.Hide},t.prototype.draw=function(){var t=this.map.getTileAt(this.attacker.position),e=this.map.getTileAt(this.target.position);this.drawBackgroundHalf(t,0),this.drawBackgroundHalf(e,1),
this.group.bringToTop(this.content_graphics),this.content_graphics.beginFill(0),this.content_graphics.drawRect(Math.floor(this.group.game.width/2)-1,0,2,this.group.game.height),this.content_graphics.endFill()},t.prototype.drawBackgroundHalf=function(e,i){var s=Math.floor(this.group.game.width/2),n=this.group.game.height,o=i*s,a=t.getBackgroundPrefixForTile(e),r=0;if(null!=a){r=48;for(var h=Math.ceil(s/176),p=0;h>p;p++)this.group.game.add.sprite(o+88*p,0,a+"_bg",0,this.group)}for(var c=Math.ceil(s/24),l=Math.ceil((n-r)/24),u=0;c>u;u++)for(var g=0;l>g;g++){var d=Math.floor(10*Math.random()),y=d>=9?2:d>=8?1:0;this.group.game.add.sprite(o+24*u,r+24*g,t.getNameForTile(e),y,this.group)}},t.prototype.update=function(){if(this.transition!=X.None){if(this.transition==X.Hide?(this.background_graphics.clear(),this.background_graphics.beginFill(0),t.drawTransition(this.transition_progress,30,this.background_graphics,this.group.game.width,this.group.game.height),this.background_graphics.endFill()):(this.transition_mask.clear(),this.transition_mask.beginFill(),t.drawTransition(this.transition_progress,30,this.transition_mask,this.group.game.width,this.group.game.height),this.transition_mask.endFill(),1==this.transition_progress&&(this.group.visible=!0)),this.transition_progress>=30){var e=this.transition;return this.transition=X.None,void this.transitionDidEnd(e)}this.transition_progress++}},t.prototype.transitionDidEnd=function(t){return t==X.Show?void console.log("Finished"):(this.draw(),this.transition_progress=0,void(this.transition=X.Show))},t})();return q}();